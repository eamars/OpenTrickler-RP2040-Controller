<!DOCTYPE html>
<html>

<head>
    <title>OpenTrickler</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Load bootstrap JS with fallback -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <script>
        (window.bootstrap || document.write('<script src="/js/bootstrap.min.js"><\/script>'));
    </script>

    <!-- Get bootstrap.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        onerror="this.onerror=null;this.href='/css/bootstrap.min.css';this.removeAttribute('integrity');this.removeAttribute('crossorigin');"
        integrity="..." crossorigin="..." />

    <style>
        .submenu-list {
            margin-left: 1rem;
        }

        html,
        body {
            height: 100%;
        }

        canvas {
            border: 1px solid black;
        }
    </style>
</head>


<body>
    <!-- Top Banner -->
    <!-- <div class="container-fluid p-1 bg-dark text-white text-center">
        <h1>OpenTrickler</h1>
    </div> -->

    <!-- Modal for popup dialog -->
    <div class="modal fade" id="saveToEepromDialog" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Apply</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            Do you also want to save configurations to EEPROM?
            </div>
            <div class="modal-footer">
                <button type="button" id="apply" class="btn btn-primary" data-bs-dismiss="modal">Apply</button>
                <button type="button" id="save_to_eeprom" class="btn btn-success" data-bs-dismiss="modal">Save to EEPROM</button>
            </div>
            </div>
        </div>
    </div>

    <div class="container-fluid h-100">
        <div class="row h-100">
            <!-- Side panel -->
            <div class="col-auto text-white bg-dark sticky-top flex-row flex-nowrap">
                <div id="side-navbar" class="p-3 sticky-top">
                    <h1 class="display-6">OpenTrickler</h1>
                    <hr>
                    <ul class="nav nav-pills flex-column mb-auto"">
                        <li class=" nav-item">
                        <a class="active nav-link link-light" href="#control">Trickle Control</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link link-light disabled" href="#">
                                <span class="nav-link-text">Settings</span>
                                <span class="submenu-arrow">
                                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-chevron-down"
                                        fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd"
                                            d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z">
                                        </path>
                                    </svg>
                                </span>
                            </a>
                            <div id="submenu-settings">
                                <ul class="submenu-list list-unstyled">
                                    <li class="submenu-item">
                                        <a class="nav-link link-light" href="#settings-scale">Scale</a>
                                        <a class="nav-link link-light" href="#settings-profile">Profiles</a>
                                        <a class="nav-link link-light" href="#settings-charge-mode">Charge Mode</a>
                                        <a class="nav-link link-light" href="#settings-wireless">Wireless</a>
                                        <a class="nav-link link-light" href="#settings-coarse-motor">Coarse Motor</a>
                                        <a class="nav-link link-light" href="#settings-fine-motor">Fine Motor</a>
                                        <a class="nav-link link-light" href="#settings-neopixel-led">Neopixel LED</a>
                                        <a class="nav-link link-light" href="#settings-button">Buttons</a>
                                        <a class="nav-link link-light" href="#settings-system-control">System Control</a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Content -->
            <div class="col-md-9 mx-3">
                <section id="control">
                    <h1>Control</h1>
                    <div class="row my-3">
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    Charge Weight Settings
                                </div>
                                <div class="card-body">
                                    <div class="btn-group-vertical" role="group" aria-label="Basic example">
                                        <input class="text-center form-control-lg mb-2" id="charge_weight_set_point">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-outline-secondary py-3 w-100" onclick="document.getElementById('charge_weight_set_point').value=document.getElementById('charge_weight_set_point').value + '1';">1</button>
                                            <button type="button" class="btn btn-outline-secondary py-3 w-100" onclick="document.getElementById('charge_weight_set_point').value=document.getElementById('charge_weight_set_point').value + '2';">2</button>
                                            <button type="button" class="btn btn-outline-secondary py-3 w-100" onclick="document.getElementById('charge_weight_set_point').value=document.getElementById('charge_weight_set_point').value + '3';">3</button>
                                        </div>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-outline-secondary py-3 w-100" onclick="document.getElementById('charge_weight_set_point').value=document.getElementById('charge_weight_set_point').value + '4';">4</button>
                                            <button type="button" class="btn btn-outline-secondary py-3 w-100" onclick="document.getElementById('charge_weight_set_point').value=document.getElementById('charge_weight_set_point').value + '5';">5</button>
                                            <button type="button" class="btn btn-outline-secondary py-3 w-100" onclick="document.getElementById('charge_weight_set_point').value=document.getElementById('charge_weight_set_point').value + '6';">6</button>
                                        </div>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-outline-secondary py-3 w-100" onclick="document.getElementById('charge_weight_set_point').value=document.getElementById('charge_weight_set_point').value + '7';">7</button>
                                            <button type="button" class="btn btn-outline-secondary py-3 w-100" onclick="document.getElementById('charge_weight_set_point').value=document.getElementById('charge_weight_set_point').value + '8';">8</button>
                                            <button type="button" class="btn btn-outline-secondary py-3 w-100" onclick="document.getElementById('charge_weight_set_point').value=document.getElementById('charge_weight_set_point').value + '9';">9</button>
                                        </div>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-outline-secondary py-3 w-100" onclick="document.getElementById('charge_weight_set_point').value=document.getElementById('charge_weight_set_point').value + '.';">.</button>
                                            <button type="button" class="btn btn-outline-secondary py-3 w-100" onclick="document.getElementById('charge_weight_set_point').value=document.getElementById('charge_weight_set_point').value + '0';">0</button>
                                            <button type="button" class="btn btn-outline-secondary py-3 w-100" onclick="document.getElementById('charge_weight_set_point').value=document.getElementById('charge_weight_set_point').value.slice(0, -1);">&lt;</button>
                                        </div>
                                        <div class="btn-group mt-2">
                                            <button type="button" class="btn btn-primary py-3" onclick="">Go</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    Button Control
                                </div>
                                <div class="card-body">
                                    <div class="button-group">
                                        <button class="btn btn-primary btn-lg" onclick="rotaryBtnCtrl(this)" action="CCW">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16">
                                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"></path>
                                                <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"></path>
                                            </svg>
                                        </button>
                                        
                                        <button class="btn btn-primary btn-lg" onclick="rotaryBtnCtrl(this)" action="CW">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"></path>
                                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"></path>
                                            </svg>
                                        </button>

                                        <button class="btn btn-primary btn-lg" onclick="rotaryBtnCtrl(this)" action="PRESS">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-bar-down" viewBox="0 0 16 16">
                                                <path fill-rule="evenodd" d="M1 3.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5zM8 6a.5.5 0 0 1 .5.5v5.793l2.146-2.147a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 0 1 .708-.708L7.5 12.293V6.5A.5.5 0 0 1 8 6z"></path>
                                            </svg>
                                        </button>

                                        <button class="btn btn-primary btn-lg" onclick="rotaryBtnCtrl(this)" action="RST">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-left" viewBox="0 0 16 16">
                                                <path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0v2z"></path>
                                                <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Settings subsection -->
                <section id="settings-scale" class="card mb-3 mt-3" style="display: none;">
                    <div class="card-header">
                        Scale Settings
                    </div>
                    <div class="card-body">
                        <form class="config-form" id="scale_config" action="/rest/scale_config">
                            <div class="form-group mb-3">
                                <label for="s0">Scale Driver:</label>
                                <select class="form-select" id="s0" name="s0">
                                    <option value="0">AND FX-i Std</option>
                                    <option value="1">Steinberg SBS</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label for="s1">Serial Baudrate</label>
                                <select class="form-select" id="s1" name="s1">
                                    <option value="0">4800</option>
                                    <option value="1">9600</option>
                                    <option value="2">19200</option>
                                </select>
                            </div>

                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveToEepromDialog">Apply Scale Settings</button>
                        </form>
                    </div>
                </section>

                <section id="settings-profile" class="card mb-3 mt-3" style="display: none;">
                    <div class="card-header">
                        Profile Settings
                    </div>
                    <div class="card-body">
                        <form class="config-form" id="profile_config" action="/rest/profile_config">
                            <div class="form-group mb-3">
                                <label for="pf">Select Profile</label>
                                <select class="form-select" id="pf" name="pf" onchange="populateProfileSelection(this)">
                                    <option value="0">#0</option>
                                    <option value="1">#1</option>
                                    <option value="2">#2</option>
                                    <option value="3">#3</option>
                                    <option value="4">#4</option>
                                    <option value="5">#5</option>
                                    <option value="6">#6</option>
                                    <option value="7">#7</option>
                                </select>
                            </div>

                            <hr/>

                            <div class="form-group mb-3">
                                <label for="p0">Revision:</label>
                                <input type="number" class="form-control" id="p0" name="p0" step="1"
                                       data-bs-toggle="tooltip" data-bs-title="Profile revision, not to be modified">
                            </div>

                            <div class="form-group mb-3">
                                <label for="p1">Compatibility:</label>
                                <input type="number" class="form-control" id="p1" name="p1" step="1"
                                       data-bs-toggle="tooltip" data-bs-title="The compatibility bitmask, not to be modified">
                            </div>

                            <div class="form-group mb-3">
                                <label for="p2">Profile Name:</label>
                                <input type="text" class="form-control" id="p2" name="p2" maxlength="16"
                                       data-bs-toggle="tooltip" data-bs-title="The name of the current profile, limited to maximum 16 characters">
                            </div>

                            <div class="form-group mb-3">
                                <label for="p3">Coarse Trickler Kp:</label>
                                <input type="number" class="form-control" id="p3" name="p3" step="0.001">
                            </div>

                            <div class="form-group mb-3">
                                <label for="p4">Coarse Trickler Ki:</label>
                                <input type="number" class="form-control" id="p4" name="p4" step="0.001">
                            </div>

                            <div class="form-group mb-3">
                                <label for="p5">Coarse Trickler Kd:</label>
                                <input type="number" class="form-control" id="p5" name="p5" step="0.001">
                            </div>

                            <div class="form-group mb-3">
                                <label for="p6">Coarse Trickler Min Flow Speed (rps):</label>
                                <input type="number" class="form-control" id="p6" name="p6" step="0.001"
                                       data-bs-toggle="tooltip" data-bs-title="The minimum speed for trickling this type of powder">
                            </div>

                            <div class="form-group mb-3">
                                <label for="p7">Coarse Trickler Max Flow Speed (rps):</label>
                                <input type="number" class="form-control" id="p7" name="p7" step="0.001"
                                       data-bs-toggle="tooltip" data-bs-title="The maximum speed for trickling this type of powder">
                            </div>

                            <div class="form-group mb-3">
                                <label for="p8">Fine Trickler Kp:</label>
                                <input type="number" class="form-control" id="p8" name="p8" step="0.001">
                            </div>

                            <div class="form-group mb-3">
                                <label for="p9">Fine Trickler Ki:</label>
                                <input type="number" class="form-control" id="p9" name="p9" step="0.001">
                            </div>

                            <div class="form-group mb-3">
                                <label for="p10">Fine Trickler Kd:</label>
                                <input type="number" class="form-control" id="p10" name="p10" step="0.001">
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="p11">Fine Trickler Min Flow Speed (rps):</label>
                                <input type="number" class="form-control" id="p11" name="p11" step="0.001"
                                       data-bs-toggle="tooltip" data-bs-title="The minimum speed for trickling this type of powder">
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="p12">Fine Trickler Max Flow Speed (rps):</label>
                                <input type="number" class="form-control" id="p12" name="p12" step="0.001"
                                       data-bs-toggle="tooltip" data-bs-title="The maximum speed for trickling this type of powder">
                            </div>

                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveToEepromDialog">Apply Profile Config</button>
                            <!-- <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#profileDatabaseDialog">Profile Database</button> -->

                            <!-- Modal for popup dialog -->
                            <!-- <div class="modal fade" id="profileDatabaseDialog" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered modal-fullscreen">
                                  <div class="modal-content">
                                    <div class="modal-header">
                                      <h1 class="modal-title fs-5" id="modalLabel">Profile Database</h1>
                                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <table class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Revision</th>
                                                    <th>Compatibility</th>
                                                    <th>Coarse Kp</th>
                                                    <th>Coarse Ki</th>
                                                    <th>Coarse Kd</th>
                                                    <th>Coarse Min Flow Speed (rps)</th>
                                                    <th>Coarse Max Flow Speed (rps)</th>
                                                    <th>Fine Kp</th>
                                                    <th>Fine Ki</th>
                                                    <th>Fine Kd</th>
                                                    <th>Fine Min Flow Speed (rps)</th>
                                                    <th>Fine Max Flow Speed (rps)</th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                      <button type="button" class="btn btn-primary">Save changes</button>
                                    </div>
                                  </div>
                                </div>
                            </div> -->
                        </form>
                    </div>
                </section>

                <section id="settings-charge-mode" class="card mb-3 mt-3" style="display: none;">
                    <div class="card-header">
                        Charge Mode Settings
                    </div>
                    <div class="card-body">
                        <form class="config-form" id="charge_mode_config" action="/rest/charge_mode_config">
                            <div class="form-group mb-3">
                                <label for="c5">Coarse Trickler Stop Threshold:</label>
                                <input type="number" class="form-control" id="c5" name="c5" step="0.001"
                                       data-bs-toggle="tooltip" data-bs-title="If the current charge weight is less than the threshold then the coarse trickler will stop">
                            </div>

                            <div class="form-group mb-3">
                                <label for="c6">Fine Trickler Stop Threshold:</label>
                                <input type="number" class="form-control" id="c6" name="c6" step="0.001"
                                       data-bs-toggle="tooltip" data-bs-title="If the current charge weight is less than the threshold then both coarse and fine trickler will stop">
                            </div>

                            <div class="form-group mb-3">
                                <label for="c7">Set Point Accuracy (Standard Deviation):</label>
                                <input type="number" class="form-control" id="c7" name="c7" step="0.001">
                            </div>

                            <div class="form-group mb-3">
                                <label for="c8">Set Point Accuracy (Mean):</label>
                                <input type="number" class="form-control" id="c8" name="c8" step="0.001">
                            </div>

                            <div class="form-group mb-3">
                                <label for="c1">Neopixel LED Normal Charge Colour</label>
                                <input type="color" class="form-control form-control-color" id="c1" name="c1">
                            </div>

                            <div class="form-group mb-3">
                                <label for="c2">Neopixel LED Under Charge Colour</label>
                                <input type="color" class="form-control form-control-color" id="c2" name="c2">
                            </div>

                            <div class="form-group mb-3">
                                <label for="c3">Neopixel LED Over Charge Colour</label>
                                <input type="color" class="form-control form-control-color" id="c3" name="c3">
                            </div>

                            <div class="form-group mb-3">
                                <label for="c4">Neopixel LED Not Ready Colour</label>
                                <input type="color" class="form-control form-control-color" id="c4" name="c4">
                            </div>

                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveToEepromDialog">Apply Charge Mode Settings</button>
                        </form>
                    </div>
                </section>

                <section id="settings-wireless" class="card mb-3 mt-3" style="display: none;">
                    <div class="card-header">
                        Wireless Settings
                    </div>
                    <div class="card-body">
                        <form class="config-form" id="wireless_config" action="/rest/wireless_config">
                            <div class="form-group mb-3">
                                <label for="w0">WiFi SSID:</label>
                                <input type="text" class="form-control" id="w0" name="w0">
                            </div>

                            <div class="form-group mb-3">
                                <label for="w1">WiFi Password:</label>
                                <input type="password" class="form-control" id="w1" name="w1">
                            </div>

                            <div class="form-group mb-3">
                                <label for="w2">WiFi Authentication Method:</label>
                                <select class="form-select" id="w2" name="w2">
                                    <option value="0">None</option>
                                    <option value="1">WPA-TKIP</option>
                                    <option value="2">WPA2-AES</option>
                                    <option value="3">WPA2-MIXED</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label for="w3">WiFi Attempt to Connect Timeout (ms):</label>
                                <input type="number" class="form-control" id="w3" name="w3"
                                       data-bs-toggle="tooltip" data-bs-title="Default: 30000">
                            </div>

                            <div class="form-group mb-3">
                                <label for="w4">Use WiFi:</label>
                                <select class="form-select" id="w4" name="w4">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveToEepromDialog">Apply Wireless Settings</button>
                        </form>
                    </div>
                </section>

                <section id="settings-coarse-motor" class="card mb-3 mt-3" style="display: none;">
                    <div class="card-header">
                        Coarse Motor Settings
                    </div>
                    <div class="card-body">
                        <form class="config-form" id="coarse_motor_config" action="/rest/coarse_motor_config">
                            <div class="form-group mb-3">
                                <label for="m0">Angular Acceleration (rps/s):</label>
                                <input type="number" class="form-control" id="m0" name="m0" step="1">
                            </div>

                            <div class="form-group mb-3">
                                <label for="m1">Full Steps per Rotation:</label>
                                <select class="form-select" id="m1" name="m1"
                                        data-bs-toggle="tooltip" data-bs-title="Select 200 steps for 1.8 deg stepper motor, 400 for 0.9 deg stepper motor">
                                    <option value="200">200</option>
                                    <option value="400">400</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label for="m2">Current (mA):</label>
                                <input type="number" class="form-control" id="m2" name="m2" step="1">
                            </div>

                            <div class="form-group mb-3">
                                <label for="m3">Microsteps:</label>
                                <select class="form-select" id="m3" name="m3">
                                    <option value="16">16</option>
                                    <option value="32">32</option>
                                    <option value="64">64</option>
                                    <option value="128">128</option>
                                    <option value="256">256</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label for="m4">Max Speed (rps):</label>
                                <input type="number" class="form-control" id="m4" name="m4"
                                    step="0.1">
                            </div>

                            <div class="form-group mb-3">
                                <label for="m6">Min Speed (rps):</label>
                                <input type="number" class="form-control" id="m6" name="m6"
                                    step="0.001">
                            </div>

                            <div class="form-group mb-3">
                                <label for="m5">Current Sensing Resistor (mOhm):</label>
                                <input type="number" class="form-control" id="m5" name="m5" step="1"
                                       data-bs-toggle="tooltip" data-bs-title="Consult the manufactor for the on-board sense resistor">
                            </div>

                            <div class="form-group mb-3">
                                <label for="m7">Gear Ratio:</label>
                                <input type="number" class="form-control" id="m7" name="m7" step="0.0000001"
                                       data-bs-toggle="tooltip" data-bs-title="The speed ratio between the driver and driven gear">
                            </div>

                            <div class="form-group mb-3">
                                <label for="m8">Inverted Enable Pin:</label>
                                <select class="form-select" id="m8" name="m8">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label for="m9">Inverted Step Direction Pin:</label>
                                <select class="form-select" id="m9" name="m9">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveToEepromDialog">Apply Coarse Motor Settings</button>

                        </form>
                    </div>
                </section>

                <section id="settings-fine-motor" class="card mb-3 mt-3" style="display: none;">
                    <div class="card-header">
                        Fine Motor Settings
                    </div>
                    <div class="card-body">
                        <form class="config-form" id="fine_motor_config" action="/rest/fine_motor_config">
                            <div class="form-group mb-3">
                                <label for="m0">Angular Acceleration (rps/s):</label>
                                <input type="number" class="form-control" id="m0" name="m0" step="1">
                            </div>

                            <div class="form-group mb-3">
                                <label for="m1">Full Steps per Rotation:</label>
                                <select class="form-select" id="m1" name="m1"
                                        data-bs-toggle="tooltip" data-bs-title="Select 200 steps for 1.8 deg stepper motor, 400 for 0.9 deg stepper motor">
                                    <option value="200">200</option>
                                    <option value="400">400</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label for="m2">Current (mA):</label>
                                <input type="number" class="form-control" id="m2" name="m2" step="1">
                            </div>

                            <div class="form-group mb-3">
                                <label for="m3">Microsteps:</label>
                                <select class="form-select" id="m3" name="m3">
                                    <option value="16">16</option>
                                    <option value="32">32</option>
                                    <option value="64">64</option>
                                    <option value="128">128</option>
                                    <option value="256">256</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label for="m4">Max Speed (rps):</label>
                                <input type="number" class="form-control" id="m4" name="m4"
                                    step="0.1">
                            </div>

                            <div class="form-group mb-3">
                                <label for="m6">Min Speed (rps):</label>
                                <input type="number" class="form-control" id="m6" name="m6"
                                    step="0.001">
                            </div>

                            <div class="form-group mb-3">
                                <label for="m5">Current Sensing Resistor (mOhm):</label>
                                <input type="number" class="form-control" id="m5" name="m5" step="1"
                                       data-bs-toggle="tooltip" data-bs-title="Consult the manufactor for the on-board sense resistor">
                            </div>

                            <div class="form-group mb-3">
                                <label for="m7">Gear Ratio:</label>
                                <input type="number" class="form-control" id="m7" name="m7" step="0.0000001"
                                       data-bs-toggle="tooltip" data-bs-title="The speed ratio between the driver and driven gear">
                            </div>

                            <div class="form-group mb-3">
                                <label for="m8">Inverted Enable Pin:</label>
                                <select class="form-select" id="m8" name="m8">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label for="m9">Inverted Step Direction Pin:</label>
                                <select class="form-select" id="m9" name="m9">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveToEepromDialog">Apply Fine Motor Settings</button>
                        </form>
                    </div>
                </section>

                <section id="settings-neopixel-led" class="card mb-3 mt-3" style="display: none;">
                    <div class="card-header">
                        Neopixel LED Settings
                    </div>

                    <div class="card-body">
                        <form class="config-form" id="neopixel_led_config" action="/rest/neopixel_led_config">
                            <div class="form-group mb-3">
                                <label for="bl">Mini 12864 Display Background Colour:</label>
                                <input type="color" class="form-control form-control-color" id="bl" name="bl">
                            </div>

                            <div class="form-group mb-3">
                                <label for="l1">LED1 Default Colour</label>
                                <input type="color" class="form-control form-control-color" id="l1" name="l1">
                            </div>

                            <div class="form-group mb-3">
                                <label for="l2">LED2 Default Colour</label>
                                <input type="color" class="form-control form-control-color" id="l2" name="l2">
                            </div>

                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveToEepromDialog">Apply Neopixel LED Settings</button>
                        </form>
                    </div>
                </section>

                <section id="settings-button" class="card mb-3 mt-3" style="display: none;">
                    <div class="card-header">
                        Buttons Settings
                    </div>

                    <div class="card-body">
                        <form class="config-form" id="button_config" action="/rest/button_config">
                            <div class="form-group mb-3">
                                <label for="b0">Inverted Rotary Button Direction:</label>
                                <select class="form-select" id="b0" name="b0">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveToEepromDialog">Apply Buttons Settings</button>
                        </form>
                    </div>
                </section>

                <section id="settings-system-control" class="card mb-3 mt-3" style="display: none;">
                    <div class="card-header">
                        System Control
                    </div>
                    <div class="card-body">
                        <form class="config-form" id="system_control" action="/rest/system_control">
                            <div class="form-group mb-3">
                                <label for="s0">Unique ID:</label>
                                <!-- Don't show unique id when submit -->
                                <input type="text" class="form-control" id="s0" name="s0" disabled="disabled" readonly
                                       data-bs-toggle="tooltip" data-bs-title="Unique Identification for your OpenTrickler">
                            </div>

                            <div class="form-group mb-3">
                                <label for="s1">Firmware Version:</label>
                                <!-- Don't show unique id when submit -->
                                <input type="text" class="form-control" id="s1" name="s1" disabled="disabled" readonly>
                            </div>

                            <div class="form-group mb-3">
                                <label for="s2">VCS Hash:</label>
                                <!-- Don't show unique id when submit -->
                                <input type="text" class="form-control" id="s2" name="s2" disabled="disabled" readonly
                                       data-bs-toggle="tooltip" data-bs-title="Commit number relates to this particular firmware build. Git guru will understand this.">
                            </div>

                            <div class="form-group mb-3">
                                <label for="s3">Firmware Build Type:</label>
                                <!-- Don't show unique id when submit -->
                                <input type="text" class="form-control" id="s3" name="s3" disabled="disabled" readonly
                                       data-bs-toggle="tooltip" data-bs-title="Type of the firmware releases">
                            </div>

                            <div class="form-group mb-3">
                                <label for="s4">Save to EEPROM:</label>
                                <select class="form-select" id="s4" name="s4"
                                        data-bs-toggle="tooltip" data-bs-title="Save all pending settings to EEPROM">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label for="s5">Reboot:</label>
                                <select class="form-select" id="s5" name="s5"
                                        data-bs-toggle="tooltip" data-bs-title="OpenTrickler will reboot if this option is Yes">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <span class="badge text-bg-warning">Warning</span>
                                <label for="s6"> Erase EEPROM:</label>
                                <select class="form-select" id="s6" name="s6"
                                        data-bs-toggle="tooltip" data-bs-title="You cannot undo the erasing of EEPROM">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#systemControlDialog">Apply System Control</button>
                        </form>
                    </div>

                    <!-- Modal for popup dialog specifically for system control-->
                    <div class="modal fade" id="systemControlDialog" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Apply System Control</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">

                            </div>
                            <div class="modal-footer">
                                <button type="button" id="confirm" class="btn btn-danger" data-bs-dismiss="modal">Confirm</button>
                            </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        // Enable tooltip
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

        // Show or display sections from the side bar
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const targetSectionId = link.getAttribute('href').substring(1);
                const targetSection = document.getElementById(targetSectionId)
                const sections = document.querySelectorAll('section');

                // Fetch data
                populateConfigOptions(targetSection);

                // Only display the target one
                sections.forEach(section => {
                    if (section === targetSection) {
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                    }
                });

                // Highlight the link
                navLinks.forEach(navLink => {
                    navLink.classList.remove('active');
                });
                link.classList.add('active');
            });
        });

        async function getRestJson(url) {
            const response = await fetch(url);
            const jsonData = await response.json();
            return jsonData;
        }

        function populateConfigOptions(targetSection) {
            // Assume we always have form under the section
            const targetForm = targetSection.querySelector("form");

            // Skip if the target doesn't have the form input (for options)
            if (targetForm) {
                const restQueryURL = "/rest/" + targetForm.id;
                // Send query and populate user options
                getRestJson(restQueryURL).then(jsonData => {
                    for (const key in jsonData) {
                        // Look for the input/select by its name
                        const formElement = targetForm.querySelector('[name="' + key + '"]');
                        if (formElement) {
                            const value = jsonData[key];
                            formElement.value = String(value);
                        }
                    }
                });
            }
        }

        function populateProfileSelection(selectedObject) {
            const restQueryURL = "/rest/profile_config?pf=" + selectedObject.value;
            const targetForm = selectedObject.form

            // Send query and populate user options
            getRestJson(restQueryURL).then(jsonData => {
                for (const key in jsonData) {
                    // Look for the input/select by its name
                    const formElement = targetForm.querySelector('[name="' + key + '"]');
                    if (formElement) {
                        const value = jsonData[key];
                        formElement.value = String(value);
                    }
                }
            });
        }

        // Callback to the button control action
        function rotaryBtnCtrl(btn) {
            const btn_action = btn.getAttribute("action");
            const url = "/rest/button_control?" + btn_action + "=true";

            // Send async event
            getRestJson(url).then(
                // TODO: Check for error
            );
        }

        function putForm(targetForm, save_to_eeprom) {
            const paramData = new FormData(targetForm);

            // Remove empty param
            for (const [key, value] of paramData.entries()) {
                if (value == "") {
                    paramData.delete(key);
                }
            }

            if (save_to_eeprom) {
                paramData.append('ee', true)
            }

            const queryString = new URLSearchParams(paramData).toString();
            const url = new URL(targetForm.action + '?');
            url.search = queryString;

            // // Post the new param with GET method
            getRestJson(url.toString()).then(
                // TODO: Check for error
            );
        }

        const saveToEepromDialogModal = document.getElementById('saveToEepromDialog')
        saveToEepromDialogModal.addEventListener('show.bs.modal', event => {
            // Example: https://getbootstrap.com/docs/5.2/components/modal/#varying-modal-content
            // Button that triggered the modal
            const button = event.relatedTarget;

            // Update title
            const modalTitle = saveToEepromDialogModal.querySelector('.modal-title');
            modalTitle.innerHTML = button.innerText;

            // Trigger push
            const targetForm = button.closest('form');
            
            // Find function to the button
            const apply_button = saveToEepromDialogModal.querySelector('#apply');
            const save_to_eeprom_button = saveToEepromDialogModal.querySelector('#save_to_eeprom');

            apply_button.onclick = function() {
                putForm(targetForm, false);
            }

            save_to_eeprom_button.onclick = function() {
                putForm(targetForm, true);
            }

        })


        const systemControlDialogModal = document.getElementById('systemControlDialog')
        systemControlDialogModal.addEventListener('show.bs.modal', event => {
            // Example: https://getbootstrap.com/docs/5.2/components/modal/#varying-modal-content
            // Button that triggered the modal
            const button = event.relatedTarget;
            const targetForm = button.closest('form');
            const modalBody = systemControlDialogModal.querySelector('.modal-body');

            var formData = new FormData(targetForm);

            // Form the content string
            let bodyText = '<p class="fw-bold">Pending Actions</p><ul>';
            if (formData.get("s4") == 'true') {
                bodyText += "<li>Save all settings to EEPROM</li>";
            }
            if (formData.get("s5") == 'true') {
                bodyText += "<li>Reboot the OpenTrickler</li>";
            }
            if (formData.get("s6") == 'true') {
                bodyText += "<li>Erase the EEPROM. You cannot undo this action!</li>";
            }

            bodyText += "</ul>"

            modalBody.innerHTML = bodyText;

            // Find function to the button
            const confirm_button = systemControlDialogModal.querySelector('#confirm');

            confirm_button.onclick = function() {
                putForm(targetForm, false);
            }
        })

    </script>
</body>

</html>