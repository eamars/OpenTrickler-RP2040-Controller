<!DOCTYPE html>
<html>

<head>
    <title>OpenTrickler Mobile</title>

    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.3/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>

<body>

<div class="container mx-auto px-2">
    <!-- The Trickle Control Page -->
    <section id="section_trickler" >
        <div class="grid grid-cols-1 gap-2">
            <!-- Row 1 -->
            <div class="stat">
                <div class="stat-title">Current Weight</div>
                <div id="currentWeightDecimal" class="stat-value">---</div>
                <div id="profileName" class="stat-desc text-primary" onclick="onProfileNameClicked()">Unknown Profile</div>
                <div class="stat-desc">
                    <progress id="currentWeightProgressPencentage" class="progress progress-primary" value="100" max="100"></progress>
                </div>
            </div>

            <!-- Row 2 -->
            <ul class="steps">
                <li id="chargeModeStateWait" class="step step-primary">Wait</li>
                <li id="chargeModeStateCharging" class="step">Charging</li>
                <li id="chargeModeStateRemoveCup" class="step">Remove Cup</li>
                <li id="chargeModeStateReturnCup" class="step">Return Cup</li>
            </ul>

            <!-- Row 3 -->
            <div class="divider">Trickler Control</div>

            <!-- Row 4 -->
            <input id="chargeWeightInput" type="number" step="0.001" placeholder="Charge Weight" class="input input-bordered input-primary" pattern="[0-9]+([\.,][0-9]+)?"/>

            <!-- Row 5 -->
            <div class="grid grid-cols-2 gap-2">
                <button id="confirmButton" class="btn btn-primary btn-lg" onclick="setChargeWeight()">Start</button>
                <button id="stopButton" class="btn btn-warning btn-lg" onclick="stopTrickler()" disabled="disabled">Stop</button>
            </div>

            <!-- Row 6 -->
            <div class="divider">Scale</div>
            <div class="grid grid-cols-1 gap-2">
                <button class="btn btn-neutral" onclick="scaleForceZero()">Scale Zero</button>
            </div>
        </div>
    </section>

    <!-- The Settings Page -->
    <section id="section_settings" style="display: none;">
        <div class="grid grid-cols-1 gap-2">
            <div class="drawer">
                <input id="settings_sidebar_toggle_button" type="checkbox" class="drawer-toggle" /> 
                <div class="drawer-content flex flex-col">
                  <!-- Navbar -->
                  <div class="w-full navbar">
                    <div class="flex-none lg:hidden">
                      <label for="settings_sidebar_toggle_button" aria-label="open sidebar" class="btn btn-square btn-ghost">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-6 h-6 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                      </label>
                    </div> 
                    <div class="flex-1 px-2 mx-2">Navbar Title</div>
                    <div class="flex-none hidden lg:block">
                      <ul class="menu menu-horizontal">
                        <!-- Navbar menu content here -->
                        <li><a>Navbar Item 1</a></li>
                        <li><a>Navbar Item 2</a></li>
                      </ul>
                    </div>
                  </div>
                  <!-- Page content here -->
                  Content
                </div> 
                <div class="drawer-side">
                  <label for="my-drawer-3" aria-label="close sidebar" class="drawer-overlay"></label> 
                  <ul class="menu p-4 w-80 min-h-full bg-base-200">
                    <!-- Sidebar content here -->
                    <li><a>Sidebar Item 1</a></li>
                    <li><a>Sidebar Item 2</a></li>
                  </ul>
                </div>
              </div>

        </div>
    </section>
</div>


<!-- Bottom navigation bar -->
<div class="btm-nav">
    <button id="button_trickler" class="active" onclick="onNavButtonClicked('trickler')">
        <svg class="w-5 h-5 mb-2 text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
            <path d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z"/>
        </svg>
        <span class="text-sm text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500">Trickler</span>
    </button>
    <button id="button_settings" onclick="onNavButtonClicked('settings')">
        <svg class="w-5 h-5 mb-2 text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12.25V1m0 11.25a2.25 2.25 0 0 0 0 4.5m0-4.5a2.25 2.25 0 0 1 0 4.5M4 19v-2.25m6-13.5V1m0 2.25a2.25 2.25 0 0 0 0 4.5m0-4.5a2.25 2.25 0 0 1 0 4.5M10 19V7.75m6 4.5V1m0 11.25a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5ZM16 19v-2"/>
        </svg>
        <span class="text-sm text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500">Settings</span>
    </button>
</div>


<!-- Other resources -->
<dialog id="quickChangeProfileDialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <div class="grid grid-cols-1 gap-2">
        <h3 class="font-bold text-lg">Change Profile</h3>
            <select id="quickChangeProfileSelect" class="select select-bordered w-full max-w-xs">
            </select>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <!-- if there is a button in form, it will close the modal -->
                <button id="quickChangeProfileConfirmButton" class="btn" onclick="onQuickProfileSelectConfirmed()">Confirm</button>
            </form>
        </div>
    </div>
</dialog>


<dialog id="invalidChargeWeightDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Error</h3>
        <p class="py-4">Invalid charge weight</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="overThrowDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Warning</h3>
        <p class="py-4">Over Throw!</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="underThrowDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Warning</h3>
        <p class="py-4">Under Throw!</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="scaleZeroedSuccessDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Info</h3>
        <p class="py-4">Scale Zero Successful</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="scaleZeroedFailDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Error</h3>
        <p class="py-4">Failed to Zero Scale</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Scripts to support the webapp -->
<script>
    const ChargeModeState = Object.freeze({ 
        EXIT: 0,
        WAIT: 1, 
        CHARGING: 2, 
        REMOVE_CUP: 3, 
        RETURN_CUP: 4, 
    }); 

    const ChargeModeEvent = Object.freeze({ 
        NO_EVENT: 1 << 0, 
        UNDER_CHARGE: 1 << 1, 
        OVER_CHARGE: 1 << 2, 
    });

    const ScaleAction = Object.freeze({ 
        NO_ACTION: 0,
        FORCE_ZERO: 1,
    });

    var pollSetTimeoutId;

    // Set Charge Mode Set Point with REST interface
    function setChargeWeight() {
        // Read charge weight
        const chargeWeight = document.getElementById("chargeWeightInput").value;

        // If the charge weight is empty
        if (chargeWeight == "") {
            const errorModal = document.getElementById('invalidChargeWeightDialog');
            errorModal.showModal();

            return;
        }

        // Build URI
        const uri = `/rest/charge_mode_state?s0=${encodeURIComponent(chargeWeight)}&s2=${encodeURIComponent(ChargeModeState.WAIT)}`;

        // Call set charge weight REST
        fetch(uri)
        .then(response => {
            _restartPoll();  // Start the poll immediately to update the charge status
        })
        .catch(error => {
            console.error("Error setting charge weight");
        });
    }

    // Set the charge mode to exit
    function stopTrickler() {
        // Send stop command
        // Build URI
        const uri = `/rest/charge_mode_state?s2=${encodeURIComponent(ChargeModeState.EXIT)}`;

        // Call set charge weight REST
        fetch(uri)
        .then(response => {
            _restartPoll();  // Start the poll immediately to update the charge status
        })
        .catch(error => {
            console.error("Error setting charge mode status");
        });
    }

    // Helper function to update progress widget
    const PRIMARY_CLASS = "step-primary";

    function _setChargeModeStateWidget(state) {
        const chargeModeStateWait = document.getElementById("chargeModeStateWait");
        const chargeModeStateCharging = document.getElementById("chargeModeStateCharging");
        const chargeModeStateRemoveCup = document.getElementById("chargeModeStateRemoveCup");
        const chargeModeStateReturnCup = document.getElementById("chargeModeStateReturnCup");

        switch (state) {
            case ChargeModeState.WAIT:
                chargeModeStateWait.classList.add(PRIMARY_CLASS);
                chargeModeStateCharging.classList.remove(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.remove(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)
                break;
            case ChargeModeState.CHARGING:
                chargeModeStateWait.classList.add(PRIMARY_CLASS);
                chargeModeStateCharging.classList.add(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.remove(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)
                break;
            case ChargeModeState.REMOVE_CUP:
                chargeModeStateWait.classList.add(PRIMARY_CLASS);
                chargeModeStateCharging.classList.add(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.add(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)
                break;
            case ChargeModeState.RETURN_CUP:
                chargeModeStateWait.classList.add(PRIMARY_CLASS);
                chargeModeStateCharging.classList.add(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.add(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.add(PRIMARY_CLASS)
                break;
            case ChargeModeState.EXIT:
                chargeModeStateWait.classList.remove(PRIMARY_CLASS);
                chargeModeStateCharging.classList.remove(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.remove(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)
                break;
        }
    }
    
    // Helper function to set the current weight widget
    function _setCurrentWeight(weight, percentage) {
        var currentWeightDecimal = document.getElementById("currentWeightDecimal");
        currentWeightDecimal.innerText = String(weight);

        var currentWeightProgressPencentage = document.getElementById("currentWeightProgressPencentage");
        currentWeightProgressPencentage.value = percentage;
    }

    function _setStartStopButtonWidget(isStart) {
        const confirmButton = document.getElementById("confirmButton");
        const stopButton = document.getElementById("stopButton");

        if (isStart) {
            confirmButton.disabled = true;
            stopButton.disabled = false;
        }
        else {
            stopButton.disabled = true;
            confirmButton.disabled = false;
        }
    }

    function onProfileNameClicked() {
        const quickChangeProfileDialog = document.getElementById("quickChangeProfileDialog");
        const quickChangeProfileSelect = document.getElementById("quickChangeProfileSelect");

        // Populate the dialog option and show the modal
        fetch("/rest/profile_summary")
        .then(response => {
            return response.json();
        })
        .then(data => {
            const all_profiles = data["s0"];
            const current_profile_idx = data["s1"];
            // First remove existing options
            var length = quickChangeProfileSelect.options.length;
            for(var i = 0; i < length; i += 1) {
                quickChangeProfileSelect.remove(i);     
            }
            quickChangeProfileSelect.options.length = 0;

            // Then populate according to the new list
            for (const idx in all_profiles) {
                var option = document.createElement("option");
                option.value = idx;
                option.innerText = all_profiles[idx];
                quickChangeProfileSelect.appendChild(option);
            }
            // Select the current
            quickChangeProfileSelect.value = current_profile_idx;
            
            // Show the modal
            quickChangeProfileDialog.showModal();
        })
        .catch(error => {
            console.error("Error reading profile summary");
        })
    }

    function onQuickProfileSelectConfirmed() {
        const quickChangeProfileSelect = document.getElementById("quickChangeProfileSelect");

        const uri = `/rest/profile_config?pf=${encodeURIComponent(quickChangeProfileSelect.value)}`;

        fetch(uri)
        .then(response => {
            return response.json();
        })
        .catch(error => {
            console.error("Error setting profile");
        })
    }

    // Function to poll charge mode status (weight, progress, etc)
    function pollChargeModeStatus() {
        fetch("/rest/charge_mode_state")
        .then(response => {
            return response.json()
        })
        .then(data => {
            // console.log(data);
            // Parse data
            const charge_weight_set_point = data["s0"];
            const current_charge_weight = data["s1"];
            const charge_mode_state = data["s2"];
            const charge_mode_event = data["s3"];
            const profile_name = data["s4"];

            var percentage = 0;
            if (charge_weight_set_point == 0) {
                percentage = 0;
            }
            else {
                percentage = current_charge_weight / charge_weight_set_point * 100.0;
            }

            // Update web element
            _setCurrentWeight(current_charge_weight, percentage);
            _setChargeModeStateWidget(charge_mode_state);

            profileName = document.getElementById("profileName");
            profileName.innerText = String(profile_name);
            
            if (charge_mode_state == ChargeModeState.EXIT) {
                _setStartStopButtonWidget(false);
            }
            else {
                _setStartStopButtonWidget(true);
            }

            // Process event
            if (charge_mode_event != ChargeModeEvent.NO_EVENT) {
                var dialog_name = null;
                if (charge_mode_event == ChargeModeEvent.UNDER_CHARGE) {
                    dialog_name = "underThrowDialog";
                }
                else if (charge_mode_event == ChargeModeEvent.OVER_CHARGE) {
                    dialog_name = "overThrowDialog";
                }

                // Show modal
                const dialogModal = document.getElementById(dialog_name);
                if (dialogModal) {
                    dialogModal.showModal();
                }
            }
        })
        .catch(error => {
            console.error("Error reading charge mode settings");
            _setCurrentWeight("---", 0);
            _setChargeModeStateWidget(ChargeModeState.WAIT);
        })
        .finally(() => {
            // Schedule the next event
            pollSetTimeoutId = setTimeout(pollChargeModeStatus, 500);
        })
    }

    // Send scale force zero command
    function scaleForceZero() {
        const uri = `/rest/scale_action?a0=${encodeURIComponent(ScaleAction.FORCE_ZERO)}`;

        // Call the scale action URI
        fetch(uri)
        .then(response => {
            return response.json();
        })
        .then(data => {
            // console.log(data);

            var scale_action_response = data["a0"];

            if (scale_action_response == ScaleAction.FORCE_ZERO) {
                const dialogModal = document.getElementById("scaleZeroedSuccessDialog");
                dialogModal.showModal();
            }
            else {
                const dialogModal = document.getElementById("scaleZeroedFailDialog");
                dialogModal.showModal();
        }
        })
        .catch(error => {
            console.error("Error applying force zero");
        });
    }

    // Switch pages
    function onNavButtonClicked(button) {
        const section_trickler = document.getElementById("section_trickler");
        const section_settings = document.getElementById("section_settings")

        const button_trickler = document.getElementById("button_trickler");
        const button_settings = document.getElementById("button_settings");

        if (button == 'trickler') {
            // Section control
            section_settings.style.display = "none";
            section_trickler.style.display = "block";

            // Button active control
            button_settings.classList.remove("active");
            button_trickler.classList.add("active");

            // Restart
            _restartPoll();

        }
        else if (button == 'settings') {
            section_trickler.style.display = "none";
            section_settings.style.display = "block";

            // Button active control
            button_trickler.classList.remove("active");
            button_settings.classList.add("active");

            // Remove polling event
            clearTimeout(pollSetTimeoutId);
        }
    }

    // Helper function to restart the poll immediately
    function _restartPoll() {
        clearTimeout(pollSetTimeoutId);
        pollSetTimeoutId = setTimeout(pollChargeModeStatus, 0);
    }

    // Start the long polling process when the page loads
    if (document.readyState != "loading") {
        onNavButtonClicked('trickler');
    }
    else {
        document.addEventListener('DOMContentLoaded', function() {onNavButtonClicked('trickler');});
    }

</script>

</body>

</html>