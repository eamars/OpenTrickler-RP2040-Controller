<!DOCTYPE html>
<html>

<head>
    <title>OpenTrickler Mobile</title>

    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.3/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0 viewport-fit=cover">

    <style>
        .exclude-bottom-nav {
            padding-bottom: 74px;
        }
    </style>
</head>

<body>

<div class="container mx-auto">
    <!-- The Trickle Control Page -->
    <section id="sectionTrickler" >
        <div class="grid grid-cols-1 gap-2 px-2 exclude-bottom-nav">
            <!-- Row 1 -->
            <div class="stat">
                <div class="stat-title">Current Weight</div>
                <div id="currentWeightDecimal" class="stat-value">---</div>
                <div id="profileName" class="stat-desc text-primary" onclick="onProfileNameClicked()">Unknown Profile</div>
                <div class="stat-desc">
                    <progress id="currentWeightProgressPencentage" class="progress progress-primary" value="100" max="100"></progress>
                </div>
            </div>

            <!-- Row 2 -->
            <ul class="steps">
                <li id="chargeModeStateWait" class="step step-primary">Wait</li>
                <li id="chargeModeStateCharging" class="step">Charging</li>
                <li id="chargeModeStateRemoveCup" class="step">Remove Cup</li>
                <li id="chargeModeStateReturnCup" class="step">Return Cup</li>
            </ul>

            <!-- Row 3 -->
            <div class="divider">Trickler Control</div>

            <!-- Row 4 -->
            <input id="chargeWeightInput" type="number" step="0.001" placeholder="Charge Weight" class="input input-bordered input-primary" pattern="[0-9]+([\.,][0-9]+)?"/>

            <!-- Row 5 -->
            <div class="grid grid-cols-2 gap-2">
                <button id="confirmButton" class="btn btn-primary btn-lg" onclick="setChargeWeight()">Start</button>
                <button id="stopButton" class="btn btn-warning btn-lg" onclick="stopTrickler()" disabled="disabled">Stop</button>
            </div>

            <!-- Row 6 -->
            <div class="divider">Scale</div>
            <div class="grid grid-cols-1 gap-2">
                <button class="btn btn-neutral" onclick="scaleForceZero()">Scale Zero</button>
            </div>
        </div>
    </section>

    <!-- The Settings Page -->
    <section id="sectionSettings" style="display: none;">
        <div class="drawer">
            <input id="settingsDrawer" type="checkbox" class="drawer-toggle" /> 
            <div class="drawer-content exclude-bottom-nav">
                <!-- Navbar, fixed at the top-->
                <div class="w-full navbar sticky top-0 bg-base-100">
                    <div class="flex-none">
                        <label for="settingsDrawer" aria-label="open sidebar" class="btn btn-square btn-ghost">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-6 h-6 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </label>
                    </div> 
                    <div id="settingsSectionTitle" class="w-full px-2 mx-2">---</div>
                </div>

                <div class="grid grid-cols-1 px-6 gap-2">
                    <!-- Select Scale Configuration -->
                    <section class="settings-page" id="settings-scale" name="Scale Config">
                        <form id="scaleConfigForm" action="/rest/scale_config" class="grid grid-cols-1 gap-3">
                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Scale Driver</span>
                                <select class="select select-bordered" name="s0">
                                    <option value="0">AND FX-i Std</option>
                                    <option value="1">Steinberg SBS</option>
                                    <option value="2">GNG JJB</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Serial Baudrate</span>
                                <select class="select select-bordered" name="s1">
                                    <option value="0">4800</option>
                                    <option value="1">9600</option>
                                    <option value="2">19200</option>
                                </select>
                            </div>

                            <button class="btn btn-neutral" data-bs-toggle="modal" data-bs-target="#saveToEepromDialog">Apply Scale Settings</button>
                        </form>
                    </section>

                    <!-- Select Profile Configuration -->
                    <section class="settings-page" id="settings-profile" name="Profile Config" style="display: none;">
                        <form id="profileConfigForm" action="/rest/profile_config" class="grid grid-cols-1 gap-3">
                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Select Profile</span>
                                <select class="select select-bordered select-primary" name="pf">
                                    <option value="0">#0</option>
                                    <option value="1">#1</option>
                                    <option value="2">#2</option>
                                    <option value="3">#3</option>
                                    <option value="4">#4</option>
                                    <option value="5">#5</option>
                                    <option value="6">#6</option>
                                    <option value="7">#7</option>
                                </select>
                            </div>

                            <div class="divider"></div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Profile Name</span>
                                <input type="text" class="input input-bordered" name="p2" maxlength="16">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Coarse Trickler Kp</span>
                                <input type="number" class="input input-bordered" name="p3" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Coarse Trickler Ki</span>
                                <input type="number" class="input input-bordered" name="p4" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Coarse Trickler Kd</span>
                                <input type="number" class="input input-bordered" name="p5" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Coarse Trickler Min Flow Speed (rps)</span>
                                <input type="number" class="input input-bordered" name="p6" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Coarse Trickler Max Flow Speed (rps)</span>
                                <input type="number" class="input input-bordered" name="p7" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Fine Trickler Kp</span>
                                <input type="number" class="input input-bordered" name="p8" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Fine Trickler Ki</span>
                                <input type="number" class="input input-bordered" name="p9" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Fine Trickler Kd</span>
                                <input type="number" class="input input-bordered" name="p10" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Fine Trickler Min Flow Speed (rps)</span>
                                <input type="number" class="input input-bordered" name="p11" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Fine Trickler Max Flow Speed (rps)</span>
                                <input type="number" class="input input-bordered" name="p12" step="0.001">
                            </div>

                        </form>
                    </section>
                </div>
            </div> 
            <div class="drawer-side exclude-bottom-nav">
                <label id="closeDrawerSide" for="settingsDrawer" aria-label="close sidebar" class="drawer-overlay"></label> 
                <ul id=drawerSlide" class="menu p-2 w-60 min-h-full bg-base-200">
                    <!-- Sidebar content here -->
                    <li><a onclick="onSettingsLinkClicked('settings-scale')">Scale</a></li>
                    <li><a onclick="onSettingsLinkClicked('settings-profile')">Profiles</a></li>
                    <li><a onclick="onSettingsLinkClicked('settings-charge-mode')">Charge Mode</a></li>
                    <li><a onclick="onSettingsLinkClicked('settings-wireless')">Wireless</a></li>
                    <li><a onclick="onSettingsLinkClicked('settings-coarse-motor')">Coarse Motor</a></li>
                    <li><a onclick="onSettingsLinkClicked('settings-fine-motor')">Fine Motor</a></li>
                    <li><a onclick="onSettingsLinkClicked('settings-neopixel-led')">Neopixel LED</a></li>
                    <li><a onclick="onSettingsLinkClicked('settings-button')">Buttons</a></li>
                    <li><a onclick="onSettingsLinkClicked('settings-system-control')">System Control</a></li>
                </ul>
            </div>
        </div>

    </section>
</div>


<!-- Bottom navigation bar -->
<div class="btm-nav">
    <button id="tricklerNavButton" class="active" onclick="onNavButtonClicked('trickler')">
        <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
            <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M18.796 4H5.204a1 1 0 0 0-.753 1.659l5.302 6.058a1 1 0 0 1 .247.659v4.874a.5.5 0 0 0 .2.4l3 2.25a.5.5 0 0 0 .8-.4v-7.124a1 1 0 0 1 .247-.659l5.302-6.059c.566-.646.106-1.658-.753-1.658Z"/>
          </svg>          
        <span class="text-sm text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500">Trickler</span>
    </button>
    <!-- <button id="purgeNavButton" onclick="onNavButtonClicked('purge')">
        <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12H4m12 0-4 4m4-4-4-4m3-4h2a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3h-2"/>
          </svg>          
        <span class="text-sm text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500">Purge</span>
    </button> -->
    <button id="settingsNavButton" onclick="onNavButtonClicked('settings')">
        <svg class="w-5 h-5 mb-2 text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12.25V1m0 11.25a2.25 2.25 0 0 0 0 4.5m0-4.5a2.25 2.25 0 0 1 0 4.5M4 19v-2.25m6-13.5V1m0 2.25a2.25 2.25 0 0 0 0 4.5m0-4.5a2.25 2.25 0 0 1 0 4.5M10 19V7.75m6 4.5V1m0 11.25a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5ZM16 19v-2"/>
        </svg>
        <span class="text-sm text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500">Settings</span>
    </button>
</div>


<!-- Other resources -->
<dialog id="quickChangeProfileDialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <div class="grid grid-cols-1 gap-2">
        <h3 class="font-bold text-lg">Change Profile</h3>
            <select id="quickChangeProfileSelect" class="select select-bordered w-full max-w-xs">
            </select>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <!-- if there is a button in form, it will close the modal -->
                <button id="quickChangeProfileConfirmButton" class="btn" onclick="onQuickProfileSelectConfirmed()">Confirm</button>
            </form>
        </div>
    </div>
</dialog>

<dialog id="invalidChargeWeightDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Error</h3>
        <p class="py-4">Invalid charge weight</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="overThrowDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Warning</h3>
        <p class="py-4">Over Throw!</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="underThrowDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Warning</h3>
        <p class="py-4">Under Throw!</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="scaleZeroedSuccessDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Info</h3>
        <p class="py-4">Scale Zero Successful</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="scaleZeroedFailDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Error</h3>
        <p class="py-4">Failed to Zero Scale</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Scripts to support the webapp -->
<script>
    const ChargeModeState = Object.freeze({ 
        EXIT: 0,
        WAIT: 1, 
        CHARGING: 2, 
        REMOVE_CUP: 3, 
        RETURN_CUP: 4, 
    }); 

    const ChargeModeEvent = Object.freeze({ 
        NO_EVENT: 1 << 0, 
        UNDER_CHARGE: 1 << 1, 
        OVER_CHARGE: 1 << 2, 
    });

    const ScaleAction = Object.freeze({ 
        NO_ACTION: 0,
        FORCE_ZERO: 1,
    });

    var pollSetTimeoutId;

    // Set Charge Mode Set Point with REST interface
    function setChargeWeight() {
        // Read charge weight
        const chargeWeight = document.getElementById("chargeWeightInput").value;

        // If the charge weight is empty
        if (chargeWeight == "") {
            const errorModal = document.getElementById('invalidChargeWeightDialog');
            errorModal.showModal();

            return;
        }

        // Build URI
        const uri = `/rest/charge_mode_state?s0=${encodeURIComponent(chargeWeight)}&s2=${encodeURIComponent(ChargeModeState.WAIT)}`;

        // Call set charge weight REST
        fetch(uri)
        .then(response => {
            _restartPoll();  // Start the poll immediately to update the charge status
        })
        .catch(error => {
            console.error("Error setting charge weight");
        });
    }

    // Set the charge mode to exit
    function stopTrickler() {
        // Send stop command
        // Build URI
        const uri = `/rest/charge_mode_state?s2=${encodeURIComponent(ChargeModeState.EXIT)}`;

        // Call set charge weight REST
        fetch(uri)
        .then(response => {
            _restartPoll();  // Start the poll immediately to update the charge status
        })
        .catch(error => {
            console.error("Error setting charge mode status");
        });
    }

    // Helper function to update progress widget
    const PRIMARY_CLASS = "step-primary";

    function _setChargeModeStateWidget(state) {
        const chargeModeStateWait = document.getElementById("chargeModeStateWait");
        const chargeModeStateCharging = document.getElementById("chargeModeStateCharging");
        const chargeModeStateRemoveCup = document.getElementById("chargeModeStateRemoveCup");
        const chargeModeStateReturnCup = document.getElementById("chargeModeStateReturnCup");

        switch (state) {
            case ChargeModeState.WAIT:
                chargeModeStateWait.classList.add(PRIMARY_CLASS);
                chargeModeStateCharging.classList.remove(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.remove(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)
                break;
            case ChargeModeState.CHARGING:
                chargeModeStateWait.classList.add(PRIMARY_CLASS);
                chargeModeStateCharging.classList.add(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.remove(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)
                break;
            case ChargeModeState.REMOVE_CUP:
                chargeModeStateWait.classList.add(PRIMARY_CLASS);
                chargeModeStateCharging.classList.add(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.add(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)
                break;
            case ChargeModeState.RETURN_CUP:
                chargeModeStateWait.classList.add(PRIMARY_CLASS);
                chargeModeStateCharging.classList.add(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.add(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.add(PRIMARY_CLASS)
                break;
            case ChargeModeState.EXIT:
                chargeModeStateWait.classList.remove(PRIMARY_CLASS);
                chargeModeStateCharging.classList.remove(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.remove(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)
                break;
        }
    }
    
    // Helper function to set the current weight widget
    function _setCurrentWeight(weight, percentage) {
        var currentWeightDecimal = document.getElementById("currentWeightDecimal");
        currentWeightDecimal.innerText = String(weight);

        var currentWeightProgressPencentage = document.getElementById("currentWeightProgressPencentage");
        currentWeightProgressPencentage.value = percentage;
    }

    function _setStartStopButtonWidget(isStart) {
        const confirmButton = document.getElementById("confirmButton");
        const stopButton = document.getElementById("stopButton");

        if (isStart) {
            confirmButton.disabled = true;
            stopButton.disabled = false;
        }
        else {
            stopButton.disabled = true;
            confirmButton.disabled = false;
        }
    }

    function onProfileNameClicked() {
        const quickChangeProfileDialog = document.getElementById("quickChangeProfileDialog");
        const quickChangeProfileSelect = document.getElementById("quickChangeProfileSelect");

        // Populate the dialog option and show the modal
        fetch("/rest/profile_summary")
        .then(response => {
            return response.json();
        })
        .then(data => {
            const all_profiles = data["s0"];
            const current_profile_idx = data["s1"];
            // First remove existing options
            var length = quickChangeProfileSelect.options.length;
            for(var i = 0; i < length; i += 1) {
                quickChangeProfileSelect.remove(i);     
            }
            quickChangeProfileSelect.options.length = 0;

            // Then populate according to the new list
            for (const idx in all_profiles) {
                var option = document.createElement("option");
                option.value = idx;
                option.innerText = all_profiles[idx];
                quickChangeProfileSelect.appendChild(option);
            }
            // Select the current
            quickChangeProfileSelect.value = current_profile_idx;
            
            // Show the modal
            quickChangeProfileDialog.showModal();
        })
        .catch(error => {
            console.error("Error reading profile summary");
        })
    }

    function onQuickProfileSelectConfirmed() {
        const quickChangeProfileSelect = document.getElementById("quickChangeProfileSelect");

        const uri = `/rest/profile_config?pf=${encodeURIComponent(quickChangeProfileSelect.value)}`;

        fetch(uri)
        .then(response => {
            return response.json();
        })
        .catch(error => {
            console.error("Error setting profile");
        })
    }

    // Function to poll charge mode status (weight, progress, etc)
    function pollChargeModeStatus() {
        fetch("/rest/charge_mode_state")
        .then(response => {
            return response.json()
        })
        .then(data => {
            // console.log(data);
            // Parse data
            const charge_weight_set_point = data["s0"];
            const current_charge_weight = data["s1"];
            const charge_mode_state = data["s2"];
            const charge_mode_event = data["s3"];
            const profile_name = data["s4"];

            var percentage = 0;
            if (charge_weight_set_point == 0) {
                percentage = 0;
            }
            else {
                percentage = current_charge_weight / charge_weight_set_point * 100.0;
            }

            // Update web element
            _setCurrentWeight(current_charge_weight, percentage);
            _setChargeModeStateWidget(charge_mode_state);

            profileName = document.getElementById("profileName");
            profileName.innerText = String(profile_name);
            
            if (charge_mode_state == ChargeModeState.EXIT) {
                _setStartStopButtonWidget(false);
            }
            else {
                _setStartStopButtonWidget(true);
            }

            // Process event
            if (charge_mode_event != ChargeModeEvent.NO_EVENT) {
                var dialog_name = null;
                if (charge_mode_event == ChargeModeEvent.UNDER_CHARGE) {
                    dialog_name = "underThrowDialog";
                }
                else if (charge_mode_event == ChargeModeEvent.OVER_CHARGE) {
                    dialog_name = "overThrowDialog";
                }

                // Show modal
                const dialogModal = document.getElementById(dialog_name);
                if (dialogModal) {
                    dialogModal.showModal();
                }
            }
        })
        .catch(error => {
            console.error("Error reading charge mode settings");
            _setCurrentWeight("---", 0);
            _setChargeModeStateWidget(ChargeModeState.WAIT);
        })
        .finally(() => {
            // Schedule the next event
            clearTimeout(pollSetTimeoutId);
            pollSetTimeoutId = setTimeout(pollChargeModeStatus, 500);
        })
    }

    // Send scale force zero command
    function scaleForceZero() {
        const uri = `/rest/scale_action?a0=${encodeURIComponent(ScaleAction.FORCE_ZERO)}`;

        // Call the scale action URI
        fetch(uri)
        .then(response => {
            return response.json();
        })
        .then(data => {
            // console.log(data);

            var scale_action_response = data["a0"];

            if (scale_action_response == ScaleAction.FORCE_ZERO) {
                const dialogModal = document.getElementById("scaleZeroedSuccessDialog");
                dialogModal.showModal();
            }
            else {
                const dialogModal = document.getElementById("scaleZeroedFailDialog");
                dialogModal.showModal();
        }
        })
        .catch(error => {
            console.error("Error applying force zero");
        });
    }

    // Switch pages
    function onNavButtonClicked(button) {
        const sectionTrickler = document.getElementById("sectionTrickler");
        const sectionSettings = document.getElementById("sectionSettings");

        const settingsNavButton = document.getElementById("settingsNavButton")
        const tricklerNavButton = document.getElementById("tricklerNavButton");
        

        if (button == 'trickler') {
            // Section control
            sectionSettings.style.display = "none";
            sectionTrickler.style.display = "block";

            // Button active control
            settingsNavButton.classList.remove("active");
            tricklerNavButton.classList.add("active");

            // Restart
            _restartPoll();

        }
        else if (button == 'settings') {
            sectionTrickler.style.display = "none";
            sectionSettings.style.display = "block";

            // Button active control
            tricklerNavButton.classList.remove("active");
            settingsNavButton.classList.add("active");

            // Remove polling event
            clearTimeout(pollSetTimeoutId);

            // Load the first settings
            onSettingsLinkClicked("settings-scale");
        }
    }

    // Helper function to restart the poll immediately
    function _restartPoll() {
        clearTimeout(pollSetTimeoutId);
        pollSetTimeoutId = setTimeout(pollChargeModeStatus, 0);
    }

    // Functions show settings page
    function onSettingsLinkClicked(sectionId) {
        const targetSection = document.getElementById(sectionId);
        const settingsSectionTitle = document.getElementById("settingsSectionTitle");

        // Enumerate all sections to set hide/display
        const sections = document.querySelectorAll('.settings-page');

        // Set visibility
        for (const section of sections) {
            if (section.id == targetSection.id) {
                section.style.display = "block";
                settingsSectionTitle.innerText = targetSection.getAttribute("name");
            }
            else {
                section.style.display = "none";
            }
        }
        
        // Close the drawer
        const settingsDrawer = document.getElementById("settingsDrawer");
        if (settingsDrawer.checked) {
            settingsDrawer.checked = false;
        }

        // Populate values
    }

    // Start the long polling process when the page loads
    if (document.readyState != "loading") {
        onNavButtonClicked('trickler');
    }
    else {
        document.addEventListener('DOMContentLoaded', function() {onNavButtonClicked('trickler');});
    }

</script>

</body>

</html>