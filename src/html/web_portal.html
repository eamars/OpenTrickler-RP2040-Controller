<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>OpenTrickler Web Controller</title>

    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.3/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0 viewport-fit=cover">
    <link rel="icon" href="https://raw.githubusercontent.com/eamars/OpenTrickler/main/Resources/favicon.ico">

    <style>
        /* Exclude the pixels taken by the bottom nav bar */
        .exclude-bottom-nav {
            padding-bottom: 64px;
        }
    </style>
</head>

<body>

<div class="container mx-auto">
    <!-- The Trickle Control Page -->
    <section id="sectionTrickler">
        <div class="grid grid-cols-1 exclude-bottom-nav">
            <!-- Row 1 -->
            <div class="grid grid-cols-2">

                <!-- Stat 1: Current Weight  -->
                <div class="stat">
                    <div class="stat-title">Current Weight</div>
                    <div id="currentWeightDecimal" class="stat-value">---</div>
                    <div id="profileName" class="stat-desc text-primary" onclick="onProfileNameClicked()">Unknown Profile</div>
                    <div class="stat-desc">
                        <progress id="currentWeightProgressPencentage" class="progress progress-primary" value="100" max="100"></progress>
                    </div>
                </div>

                <!-- Stat 2: Charging Time -->
                <div class="stat text-right">
                    <div class="stat-title">Charging Time</div>
                    <div id="chargeTimeValue" class="stat-value">-.-- s</div>
                    <!-- These two lines are placeholders to ensure vertical alignment -->
                    <div class="stat-desc"> </div>
                    <div class="stat-desc"> </div>
                </div>

            </div>

            <!-- Charge Mode Control -->
            <section id="sectionTricklerChargeMode">
                <div class="grid grid-cols-1 gap-2 px-4">
                    <!-- Row 1 -->
                    <div class="divider">Charge Control</div>
                    
                    <!-- Row 2 -->
                    <ul class="steps">
                        <li id="chargeModeStateWait" class="step step-primary">Wait</li>
                        <li id="chargeModeStateCharging" class="step">Charging</li>
                        <li id="chargeModeStateRemoveCup" class="step">Remove Cup</li>
                        <li id="chargeModeStateReturnCup" class="step">Return Cup</li>
                    </ul>

                    <!-- Row 3 -->
                    <input id="chargeWeightInput" type="number" step="0.001" placeholder="Charge Weight" class="input input-bordered input-primary" pattern="[0-9]+([\.,][0-9]+)?"/>

                    <!-- Row 4 -->
                    <div class="grid grid-cols-2 gap-2">
                        <button id="confirmButton" class="btn btn-primary btn-lg" onclick="setChargeWeight()">Start</button>
                        <button id="stopButton" class="btn btn-warning btn-lg" onclick="enterChargeMode(false)" disabled="disabled">Stop</button>
                    </div>
                </div>
            </section>

            <!-- Cleanup Mode Control -->
            <section id="sectionTricklerCleanUpMode" style="display: none;">
                <div class="grid grid-cols-1 gap-2 px-4">
                    <div class="grid grid-cols-1 gap-2"> 
                        <span class="label-text">Trickler Speed (rps)</span>
                        <input id="tricklerSpeedSlider" type="range" min="-5" max="5" value="0" class="range range-lg" step="0.1" oninput="debouncedOnTricklerSpeedUpdate()"/>
                        <button class="btn btn-primary w-full" onclick="onStopCleanupButtonClicked()">Stop</button>
                    </div>
                </div>
            </section>

            <div class="grid grid-cols-1 gap-2 px-4">
                <div class="divider">General Control</div>
                <div class="grid grid-cols-1 gap-2">
                    <button class="btn btn-neutral" onclick="scaleForceZero()">Scale Zero</button>

                    <div class="grid grid-cols-2 gap-2">
                        <button class="btn btn-neutral" onclick="servoGateSetState(2)">Gate Open</button>
                        <button class="btn btn-neutral" onclick="servoGateSetState(1)">Gate Close</button>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <!-- The Settings Page -->
    <section id="sectionSettings" style="display: none;">
        <div class="drawer">
            <input id="settingsDrawer" type="checkbox" class="drawer-toggle" /> 
            <div class="drawer-content exclude-bottom-nav">
                <!-- Navbar, fixed at the top-->
                <div class="w-full navbar sticky top-0 bg-base-100">
                    <div class="flex-none">
                        <label for="settingsDrawer" aria-label="open sidebar" class="btn btn-square btn-ghost">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-6 h-6 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </label>
                    </div> 
                    <div id="settingsSectionTitle" class="w-full px-2 mx-2">---</div>
                </div>

                <div class="grid grid-cols-1 px-6 gap-2">
                    <!-- Scale Settings -->
                    <section class="settings-page" id="settings-scale" name="Scale">
                        <form id="scaleConfigForm" action="/rest/scale_config" class="grid grid-cols-1 gap-3">
                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Scale Driver</span>
                                <select class="select select-bordered" name="s0">
                                    <option value="0">AND FX-i Std</option>
                                    <option value="1">Steinberg SBS</option>
                                    <option value="2">GNG JJB</option>
                                    <option value="3">US Solid JFDBS</option>
                                    <option value="4">JM Science</option>
                                    <option value="5">Creedmoore</option>
                                    <option value="6">Radwag PS R2</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Serial Baudrate</span>
                                <select class="select select-bordered" name="s1">
                                    <option value="0">4800</option>
                                    <option value="1">9600</option>
                                    <option value="2">19200</option>
                                </select>
                            </div>

                            <button class="btn btn-neutral settings-apply-btn">Apply</button>
                        </form>
                    </section>

                    <!-- Profile Settings -->
                    <section class="settings-page" id="settings-profile" name="Profiles" style="display: none;">
                        <form id="profileConfigForm" action="/rest/profile_config" class="grid grid-cols-1 gap-3">
                            <div class="grid grid-cols-1 gap-2">
                                <div role="alert" class="alert">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        class="h-6 w-6 shrink-0 stroke-current">
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                        </path>
                                    </svg>
                                    <a href="https://github.com/eamars/OpenTrickler/blob/main/Manual/tuning_guide.md" class="link">Powder Profile Tuning Guide</a>
                                </div>

                                <span class="label-text">Select Profile</span>
                                <select class="select select-bordered select-primary" name="pf" onchange="populateProfileSelection(this)" id="select_profile_option">
                                    <option value="0">#0</option>
                                    <option value="1">#1</option>
                                    <option value="2">#2</option>
                                    <option value="3">#3</option>
                                    <option value="4">#4</option>
                                    <option value="5">#5</option>
                                    <option value="6">#6</option>
                                    <option value="7">#7</option>
                                </select>

                                <button class="btn btn-neutral system-control-export-btn" onclick="onExportProfileBtnClicked(event)">Export Profile</button>
                            </div>

                            <div class="divider"></div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Profile Name</span>
                                <input type="text" class="input input-bordered" name="p2" maxlength="16">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Coarse Trickler Kp</span>
                                <input type="number" class="input input-bordered" name="p3" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Coarse Trickler Ki</span>
                                <input type="number" class="input input-bordered" name="p4" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Coarse Trickler Kd</span>
                                <input type="number" class="input input-bordered" name="p5" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Coarse Trickler Min Flow Speed (rps)</span>
                                <input type="number" class="input input-bordered" name="p6" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Coarse Trickler Max Flow Speed (rps)</span>
                                <input type="number" class="input input-bordered" name="p7" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Fine Trickler Kp</span>
                                <input type="number" class="input input-bordered" name="p8" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Fine Trickler Ki</span>
                                <input type="number" class="input input-bordered" name="p9" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Fine Trickler Kd</span>
                                <input type="number" class="input input-bordered" name="p10" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Fine Trickler Min Flow Speed (rps)</span>
                                <input type="number" class="input input-bordered" name="p11" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Fine Trickler Max Flow Speed (rps)</span>
                                <input type="number" class="input input-bordered" name="p12" step="0.001">
                            </div>

                            <button class="btn btn-neutral settings-apply-btn">Apply</button>
                        </form>
                    </section>

                    <!-- Charge Mode Settings -->
                    <section class="settings-page" id="settings-charge-mode" name="Charge Mode" style="display: none;">
                        <form id="chargeModeConfigForm" action="/rest/charge_mode_config" class="grid grid-cols-1 gap-3">
                            <div class="grid grid-cols-2 gap-1">
                                <span class="label-text">Neopixel LED Normal Charge Colour</span>
                                <input type="color" class="input w-full" name="c1">
                            </div>

                            <div class="grid grid-cols-2 gap-1">
                                <span class="label-text">Neopixel LED Under Charge Colour</span>
                                <input type="color" class="input w-full" name="c2">
                            </div>

                            <div class="grid grid-cols-2 gap-1">
                                <span class="label-text">Neopixel LED Over Charge Colour</span>
                                <input type="color" class="input w-full" name="c3">
                            </div>

                            <div class="grid grid-cols-2 gap-1">
                                <span class="label-text">Neopixel LED Not Ready Colour</span>
                                <input type="color" class="input w-full" name="c4">
                            </div>

                            <div class="divider"></div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Coarse Trickler Stop Threshold</span>
                                <input type="number" class="input input-bordered" name="c5" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Fine Trickler Stop Threshold</span>
                                <input type="number" class="input input-bordered" name="c6" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Set Point Accuracy (Standard Deviation)</span>
                                <input type="number" class="input input-bordered" name="c7" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Set Point Accuracy (Mean)</span>
                                <input type="number" class="input input-bordered" name="c8" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Decimal Places</span>
                                <select class="select select-bordered" name="c9">
                                    <option value="0">2</option>
                                    <option value="1">3</option>
                                </select>
                            </div>

                            <div class="divider"></div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Enable Pre-Charge (requires servo gate)</span>
                                <select class="select select-bordered" name="c10">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Pre-Charge Duration (ms)</span>
                                <input type="number" class="input input-bordered" name="c11" step="1">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Pre-Charge Speed (rps)</span>
                                <input type="number" class="input input-bordered" name="c12" step="0.001">
                            </div>

                            <button class="btn btn-neutral settings-apply-btn">Apply</button>
                        </form>
                    </section>

                    <!-- Wireless Settings -->
                    <section class="settings-page" id="settings-wireless" name="Wireless" style="display: none;">
                        <form id="wirelessConfigForm" action="/rest/wireless_config" class="grid grid-cols-1 gap-3">
                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">WiFi SSID</span>
                                <input type="text" class="input input-bordered" name="w0" maxlength="32">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <div>
                                    <div class="badge badge-neutral">Write Only</div>
                                    <span class="label-text">WiFi Password</span> 
                                </div>
                                <input type="password" class="input input-bordered" name="w1" maxlength="63" placeholder="********">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">WiFi Authentication Method</span>
                                <select class="select select-bordered" name="w2">
                                    <option value="0">None</option>
                                    <option value="1">WPA-TKIP</option>
                                    <option value="2">WPA2-AES</option>
                                    <option value="3">WPA2-MIXED</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">WiFi Attempt to Connect Timeout (ms)</span>
                                <input type="number" class="input input-bordered" name="w3" step="1000">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Enable WiFi</span>
                                <select class="select select-bordered" name="w4">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <button class="btn btn-neutral settings-apply-btn">Apply</button>
                        </form>
                    </section>

                    <!-- Coarse Trickler Motor Settings -->
                    <section class="settings-page" id="settings-coarse-motor" name="Coarse Trickler Motor" style="display: none;">
                        <form id="coarseMotorConfigForm" action="/rest/coarse_motor_config" class="grid grid-cols-1 gap-3">
                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Angular Acceleration (rps/s)</span>
                                <input type="number" class="input input-bordered" name="m0" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Full Steps per Rotation</span>
                                <select class="select select-bordered" name="m1">
                                    <option value="200">200</option>
                                    <option value="400">400</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Current (mA)</span>
                                <input type="number" class="input input-bordered" name="m2" step="1">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Microsteps</span>
                                <select class="select select-bordered" name="m3">
                                    <option value="16">16</option>
                                    <option value="32">32</option>
                                    <option value="64">64</option>
                                    <option value="128">128</option>
                                    <option value="256">256</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Max Speed (rps)</span>
                                <input type="number" class="input input-bordered" name="m4" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Min Speed (rps)</span>
                                <input type="number" class="input input-bordered" name="m6" step="0.001"> 
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Current Sensing Resistor (mOhm)</span>
                                <input type="number" class="input input-bordered" name="m5" step="1"> 
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Gear Ratio</span>
                                <input type="number" class="input input-bordered" name="m7" step="0.0000001"> 
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Inverted Enable Pin</span>
                                <select class="select select-bordered" name="m8">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Inverted Step Direction Pin</span>
                                <select class="select select-bordered" name="m9">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <button class="btn btn-neutral settings-apply-btn">Apply</button>
                        </form> 
                    </section>

                    <!-- Fine Trickler motor Settings -->
                    <section class="settings-page" id="settings-fine-motor" name="Fine Trickler Motor" style="display: none;">
                        <form id="fineMotorConfigForm" action="/rest/fine_motor_config" class="grid grid-cols-1 gap-3">
                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Angular Acceleration (rps/s)</span>
                                <input type="number" class="input input-bordered" name="m0" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Full Steps per Rotation</span>
                                <select class="select select-bordered" name="m1">
                                    <option value="200">200</option>
                                    <option value="400">400</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Current (mA)</span>
                                <input type="number" class="input input-bordered" name="m2" step="1">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Microsteps</span>
                                <select class="select select-bordered" name="m3">
                                    <option value="16">16</option>
                                    <option value="32">32</option>
                                    <option value="64">64</option>
                                    <option value="128">128</option>
                                    <option value="256">256</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Max Speed (rps)</span>
                                <input type="number" class="input input-bordered" name="m4" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Min Speed (rps)</span>
                                <input type="number" class="input input-bordered" name="m6" step="0.001"> 
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Current Sensing Resistor (mOhm)</span>
                                <input type="number" class="input input-bordered" name="m5" step="1"> 
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Gear Ratio</span>
                                <input type="number" class="input input-bordered" name="m7" step="0.0000001"> 
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Inverted Enable Pin</span>
                                <select class="select select-bordered" name="m8">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Inverted Step Direction Pin</span>
                                <select class="select select-bordered" name="m9">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <button class="btn btn-neutral settings-apply-btn">Apply</button>
                        </form> 
                    </section>

                    <!-- Neopxiel LED Settings -->
                    <section class="settings-page" id="settings-neopixel-led" name="Neopixel LED" style="display: none;">
                        <form id="neopixelLedConfigForm" action="/rest/neopixel_led_config" class="grid grid-cols-1 gap-3">
                            <div role="alert" class="alert">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span>The default Neopxiel LED colour can be overridden by Charge Mode Functions.</span>
                            </div>

                            <div class="grid grid-cols-2 gap-1">
                                <span class="label-text">Mini 12864 Display Background Colour</span>
                                <input type="color" class="input w-full" name="bl">
                            </div>

                            <div class="grid grid-cols-2 gap-1">
                                <span class="label-text">LED1 Default Colour</span>
                                <input type="color" class="input w-full" name="l1">
                            </div>

                            <div class="grid grid-cols-2 gap-1">
                                <span class="label-text">LED2 Default Colour</span>
                                <input type="color" class="input w-full" name="l2">
                            </div>

                            <div class="divider"></div>

                            <div class="grid grid-cols-2 gap-1">
                                <span class="label-text">PWM OUT Chain Count</span>
                                <select class="select select-bordered" name="l3">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">PWM OUT Is RGBW LED? (WS2812B or SK6812)</span>
                                <select class="select select-bordered" name="l4">
                                    <option value=true>Yes</option>
                                    <option value=false>No</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">PWM OUT Neopixel LED Colour Order</span>
                                <select class="select select-bordered" name="l5">
                                    <option value="0">RGB</option>
                                    <option value="1">GRB</option>
                                </select>
                            </div>

                            <button class="btn btn-neutral settings-apply-btn">Apply</button>
                        </form>
                    </section>

                    <!-- Mini 12864 Module Settings -->
                    <section class="settings-page" id="settings-mini-12864-module" name="Mini 12864 Module" style="display: none;">
                        <form id="mini12864ModuleConfigForm" action="/rest/mini_12864_config" class="grid grid-cols-1 gap-3">
                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Inverted Rotary Button Direction</span>
                                <select class="select select-bordered" name="b0">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Display Rotation (deg)</span>
                                <select class="select select-bordered" name="b1">
                                    <option value="0">0</option>
                                    <option value="2">180</option>
                                </select>
                            </div>

                            <button class="btn btn-neutral settings-apply-btn">Apply</button>
                        </form>
                    </section>

                    <section class="settings-page" id="settings-servo-gate" name="Servo Gate" style="display: none;">
                        <form id="servoGateConfigForm" action="/rest/servo_gate_config" class="grid grid-cols-1 gap-3">
                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Servo Gate Enable</span>
                                <select class="select select-bordered" name="c0">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Shutter 0 Close Duty Cycle</span>
                                <input type="number" class="input input-bordered" name="c1" step="0.001">
                            </div>
                            
                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Shutter 0 Open Duty Cycle</span>
                                <input type="number" class="input input-bordered" name="c2" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Shutter 1 Close Duty Cycle</span>
                                <input type="number" class="input input-bordered" name="c3" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Shutter 1 Open Duty Cycle</span>
                                <input type="number" class="input input-bordered" name="c4" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Shutter Close Speed (%/s)</span>
                                <input type="number" class="input input-bordered" name="c5" step="0.001">
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Shutter Open Speed (%/s)</span>
                                <input type="number" class="input input-bordered" name="c6" step="0.001">
                            </div>

                            <button class="btn btn-neutral settings-apply-btn">Apply</button>
                        </form>
                    </section>

                    <!-- System Control Page -->
                    <section class="settings-page" id="settings-system-control" name="System Control" style="display: none;">
                        <form id="systemControlForm" action="/rest/system_control" class="grid grid-cols-1 gap-3">
                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Unique ID</span>
                                <input type="text" class="input input-bordered" name="s0" disabled="disabled" readonly>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Firmware Version</span>
                                <input type="text" class="input input-bordered" name="s1" disabled="disabled" readonly>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">VCS Hash</span>
                                <input type="text" class="input input-bordered" name="s2" disabled="disabled" readonly>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Build Type</span>
                                <input type="text" class="input input-bordered" name="s3" disabled="disabled" readonly>
                            </div>

                            <div class="divider"></div>

                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Save All Changes to EEPROM</span>
                                <select class="select select-bordered" name="s4">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            
                            <div class="grid grid-cols-1 gap-1">
                                <span class="label-text">Reboot</span>
                                <select class="select select-bordered" name="s5">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-1 gap-1">
                                <div>
                                    <div class="badge badge-warning">Warning</div>
                                    <span class="label-text">Erase EEPROM</span> 
                                </div>
                                <select class="select select-bordered" name="s6">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <button class="btn btn-neutral system-control-apply-btn" id="system_control_apply_btn">Apply</button>
                        </form>

                        <div class="divider"></div>

                        <!-- Export and Import config -->
                        <div class="grid grid-cols-2 gap-1">
                            <button class="btn btn-neutral system-control-export-btn" onclick="onExportConfigClicked()">Export Config</button>
                            <button class="btn btn-neutral system-control-import-btn" onclick="onImportConfigClicked()">Import Config</button>
                        </div>

                    </section>

                </div>
            </div> 
            <div class="drawer-side exclude-bottom-nav">
                <label id="closeDrawerSide" for="settingsDrawer" aria-label="close sidebar" class="drawer-overlay"></label> 
                <ul id=drawerSlide" class="menu p-2 w-60 min-h-full bg-base-200">
                    <!-- Sidebar content here -->
                    <li><a class="text-lg" onclick="onSettingsLinkClicked('settings-scale')">Scale</a></li>
                    <li><a class="text-lg" onclick="onSettingsLinkClicked('settings-profile')">Profiles</a></li>
                    <li><a class="text-lg" onclick="onSettingsLinkClicked('settings-charge-mode')">Charge Mode</a></li>
                    <li><a class="text-lg" onclick="onSettingsLinkClicked('settings-wireless')">Wireless</a></li>
                    <li><a class="text-lg" onclick="onSettingsLinkClicked('settings-coarse-motor')">Coarse Motor</a></li>
                    <li><a class="text-lg" onclick="onSettingsLinkClicked('settings-fine-motor')">Fine Motor</a></li>
                    <li><a class="text-lg" onclick="onSettingsLinkClicked('settings-neopixel-led')">Neopixel LED</a></li>
                    <li><a class="text-lg" onclick="onSettingsLinkClicked('settings-mini-12864-module')">Mini 12864 Module</a></li>
                    <li><a class="text-lg" onclick="onSettingsLinkClicked('settings-servo-gate')">Servo Gate</a></li>
                    <li><a class="text-lg" onclick="onSettingsLinkClicked('settings-system-control')">System Control</a></li>
                </ul>
            </div>
        </div>

    </section>
</div>


<!-- Bottom navigation bar -->
<div class="btm-nav">
    <button id="tricklerNavButton" class="active" onclick="onNavButtonClicked('trickler')">
        <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
            <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M18.796 4H5.204a1 1 0 0 0-.753 1.659l5.302 6.058a1 1 0 0 1 .247.659v4.874a.5.5 0 0 0 .2.4l3 2.25a.5.5 0 0 0 .8-.4v-7.124a1 1 0 0 1 .247-.659l5.302-6.059c.566-.646.106-1.658-.753-1.658Z"/>
          </svg>          
        <span class="text-sm text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500">Trickler</span>
    </button>
    <button id="settingsNavButton" onclick="onNavButtonClicked('settings')">
        <svg class="w-5 h-5 mb-2 text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12.25V1m0 11.25a2.25 2.25 0 0 0 0 4.5m0-4.5a2.25 2.25 0 0 1 0 4.5M4 19v-2.25m6-13.5V1m0 2.25a2.25 2.25 0 0 0 0 4.5m0-4.5a2.25 2.25 0 0 1 0 4.5M10 19V7.75m6 4.5V1m0 11.25a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5ZM16 19v-2"/>
        </svg>
        <span class="text-sm text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500">Settings</span>
    </button>
    <button id="purgeNavButton" onclick="onNavButtonClicked('purge')">
        <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12H4m12 0-4 4m4-4-4-4m3-4h2a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3h-2"/>
          </svg>          
        <span class="text-sm text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500">Purge</span>
    </button>
</div>


<!-- Other resources -->
<dialog id="applySystemControlDialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <div class="grid grid-cols-1 gap-2">
            <h3 class="font-bold text-lg">Pending Actions</h3>
            <div id="systemControlDialogWarningText"></div>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <!-- if there is a button in form, it will close the modal -->
                <div class="grid grid-cols-2 gap-2">
                    <button id="dialogSystemControlApplySettingsButton" class="btn btn-error">Apply</button>
                    <button class="btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</dialog>


<dialog id="applySettingsDialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <div class="grid grid-cols-1 gap-2">
            <h3 class="font-bold text-lg">
                Save <span id="applySettingsDialogTitle"></span> Settings
            </h3>
            <p class="py-4">Do you also want to save settings to EEPROM?</p>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <!-- if there is a button in form, it will close the modal -->
                <div class="grid grid-cols-3 gap-2">
                    <button id="dialogSaveToEepromButton" class="btn btn-primary">Save to EEPROM</button>
                    <button id="dialogApplySettingsButton" class="btn btn-neutral">Apply</button>
                    <button class="btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</dialog>

<dialog id="quickChangeProfileDialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <div class="grid grid-cols-1 gap-2">
            <h3 class="font-bold text-lg">Change Profile</h3>
            <select id="quickChangeProfileSelect" class="select select-bordered w-full max-w-xs">
            </select>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <!-- if there is a button in form, it will close the modal -->
                <button id="quickChangeProfileConfirmButton" class="btn" onclick="onQuickProfileSelectConfirmed()">Confirm</button>
            </form>
        </div>
    </div>
</dialog>

<dialog id="invalidChargeWeightDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Error</h3>
        <p class="py-4">Invalid charge weight</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="overThrowDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Warning</h3>
        <p class="py-4">Over Throw!</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="underThrowDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Warning</h3>
        <p class="py-4">Under Throw!</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="settingsAppliedSuccessDialog" class="modal">
    <div class="modal-box" id="settingsAppliedSuccessText">
        <h3 class="font-bold text-lg">Info</h3>
        <p class="py-4">Settings Applied</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="settingsRestoreFailedDialog" class="modal">
    <div class="modal-box" id="settingsRestoreFailedText">
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="scaleZeroedSuccessDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Info</h3>
        <p class="py-4">Scale Zero Successful</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<dialog id="scaleZeroedFailDialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Error</h3>
        <p class="py-4">Failed to Zero Scale</p>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Scripts to support the webapp -->
<script>
    const ChargeModeState = Object.freeze({ 
        EXIT: 0,
        WAIT: 1, 
        CHARGING: 2, 
        REMOVE_CUP: 3, 
        RETURN_CUP: 4, 
    }); 

    const ChargeModeEvent = Object.freeze({ 
        NO_EVENT: 1 << 0, 
        UNDER_CHARGE: 1 << 1, 
        OVER_CHARGE: 1 << 2, 
    });

    const ScaleAction = Object.freeze({ 
        NO_ACTION: 0,
        FORCE_ZERO: 1,
    });

    const CleanupModeState = Object.freeze({
        EXIT: 0,
        ENTER: 1,
    });

    const ServoGateState = Object.freeze({
        GATE_DISABLED: 0,
        GATE_CLOSE: 1,
        GATE_OPEN: 2,
    });

    var pollSetTimeoutId;

    // Set Charge Mode Set Point with REST interface
    function setChargeWeight() {
        // Read charge weight
        const chargeWeight = document.getElementById("chargeWeightInput").value;

        // If the charge weight is empty
        if (chargeWeight == "") {
            const errorModal = document.getElementById('invalidChargeWeightDialog');
            errorModal.showModal();

            return;
        }

        // Build URI
        const uri = `/rest/charge_mode_state?s0=${encodeURIComponent(chargeWeight)}&s2=${encodeURIComponent(ChargeModeState.WAIT)}`;

        // Call set charge weight REST
        fetch(uri)
        .then(response => {
            _restartPoll();  // Start the poll immediately to update the charge status
        })
        .catch(error => {
            console.error("Error setting charge weight");
        });
    }

    function enterChargeMode(enter) {
        var charge_mode_status_value = null;
        if (enter) {
            charge_mode_status_value = ChargeModeState.WAIT;
        }
        else {
            charge_mode_status_value = ChargeModeState.EXIT;
        }

        // Build URI
        const uri = `/rest/charge_mode_state?s2=${encodeURIComponent(charge_mode_status_value)}`;

        // Call set charge weight REST
        fetch(uri)
        .then(response => {
            _restartPoll();  // Start the poll immediately to update the charge status
        })
        .catch(error => {
            console.error("Error setting charge mode status");
        });
    }

    // Helper function to update progress widget
    const PRIMARY_CLASS = "step-primary";

    function _setChargeModeStateWidget(state) {
        const chargeModeStateWait = document.getElementById("chargeModeStateWait");
        const chargeModeStateCharging = document.getElementById("chargeModeStateCharging");
        const chargeModeStateRemoveCup = document.getElementById("chargeModeStateRemoveCup");
        const chargeModeStateReturnCup = document.getElementById("chargeModeStateReturnCup");

        switch (state) {
            case ChargeModeState.WAIT:
                chargeModeStateWait.classList.add(PRIMARY_CLASS);
                chargeModeStateCharging.classList.remove(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.remove(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)
                break;
            case ChargeModeState.CHARGING:
                chargeModeStateWait.classList.add(PRIMARY_CLASS);
                chargeModeStateCharging.classList.add(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.remove(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)
                break;
            case ChargeModeState.REMOVE_CUP:
                chargeModeStateWait.classList.add(PRIMARY_CLASS);
                chargeModeStateCharging.classList.add(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.add(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)
                break;
            case ChargeModeState.RETURN_CUP:
                chargeModeStateWait.classList.add(PRIMARY_CLASS);
                chargeModeStateCharging.classList.add(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.add(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.add(PRIMARY_CLASS)
                break;
            case ChargeModeState.EXIT:
                chargeModeStateWait.classList.remove(PRIMARY_CLASS);
                chargeModeStateCharging.classList.remove(PRIMARY_CLASS)
                chargeModeStateRemoveCup.classList.remove(PRIMARY_CLASS)
                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)
                break;
        }
    }
    
    // Helper function to set the current weight widget
    function _setCurrentWeight(weight, percentage) {
        var currentWeightDecimal = document.getElementById("currentWeightDecimal");
        currentWeightDecimal.innerText = String(weight);

        var currentWeightProgressPencentage = document.getElementById("currentWeightProgressPencentage");
        currentWeightProgressPencentage.value = percentage;
    }

    function _setStartStopButtonWidget(isStart) {
        const confirmButton = document.getElementById("confirmButton");
        const stopButton = document.getElementById("stopButton");

        if (isStart) {
            confirmButton.disabled = true;
            stopButton.disabled = false;
        }
        else {
            stopButton.disabled = true;
            confirmButton.disabled = false;
        }
    }

    function onProfileNameClicked() {
        const quickChangeProfileDialog = document.getElementById("quickChangeProfileDialog");
        const quickChangeProfileSelect = document.getElementById("quickChangeProfileSelect");

        // Populate the dialog option and show the modal
        fetch("/rest/profile_summary")
        .then(response => {
            return response.json();
        })
        .then(data => {
            const all_profiles = data["s0"];
            const current_profile_idx = data["s1"];
            // First remove existing options
            var length = quickChangeProfileSelect.options.length;
            for(var i = 0; i < length; i += 1) {
                quickChangeProfileSelect.remove(i);     
            }
            quickChangeProfileSelect.options.length = 0;

            // Then populate according to the new list
            for (const idx in all_profiles) {
                var option = document.createElement("option");
                option.value = idx;
                option.innerText = all_profiles[idx];
                quickChangeProfileSelect.appendChild(option);
            }
            // Select the current
            quickChangeProfileSelect.value = current_profile_idx;
            
            // Show the modal
            quickChangeProfileDialog.showModal();
        })
        .catch(error => {
            console.error("Error reading profile summary");
        })
    }

    function onQuickProfileSelectConfirmed() {
        const quickChangeProfileSelect = document.getElementById("quickChangeProfileSelect");

        const uri = `/rest/profile_config?pf=${encodeURIComponent(quickChangeProfileSelect.value)}`;

        fetch(uri)
        .then(response => {
            return response.json();
        })
        .catch(error => {
            console.error("Error setting profile");
        })
    }

    // Function to poll charge mode status (weight, progress, etc)
    function pollChargeModeStatus() {
        fetch("/rest/charge_mode_state")
        .then(response => {
            return response.json()
        })
        .then(data => {
            // console.log(data);
            // Parse data
            const charge_weight_set_point = data["s0"];
            const current_charge_weight = data["s1"];
            const charge_mode_state = data["s2"];
            const charge_mode_event = data["s3"];
            const profile_name = data["s4"];
            const charge_time_seconds = data["s5"] || "-.--";

            var percentage = 0;
            if (charge_weight_set_point == 0) {
                percentage = 0;
            }
            else {
                percentage = current_charge_weight / charge_weight_set_point * 100.0;
            }

            // Update web element
            _setCurrentWeight(current_charge_weight, percentage);
            _setChargeModeStateWidget(charge_mode_state);

            profileName = document.getElementById("profileName");
            profileName.innerText = String(profile_name);
            
            // Find the charge time element and update its text content
            const chargeTimeElement = document.getElementById('chargeTimeValue');
            if (chargeTimeElement) {
                chargeTimeElement.textContent = `${charge_time_seconds} s`;
            }

            if (charge_mode_state == ChargeModeState.EXIT) {
                _setStartStopButtonWidget(false);
            }
            else {
                _setStartStopButtonWidget(true);
            }

            // Process event
            if (charge_mode_event != ChargeModeEvent.NO_EVENT) {
                var dialog_name = null;
                if (charge_mode_event == ChargeModeEvent.UNDER_CHARGE) {
                    dialog_name = "underThrowDialog";
                }
                else if (charge_mode_event == ChargeModeEvent.OVER_CHARGE) {
                    dialog_name = "overThrowDialog";
                }

                // Show modal
                const dialogModal = document.getElementById(dialog_name);
                if (dialogModal) {
                    dialogModal.showModal();
                }
            }
        })
        .catch(error => {
            console.error("Error reading charge mode settings");
            _setCurrentWeight("---", 0);
            _setChargeModeStateWidget(ChargeModeState.WAIT);
        })
        .finally(() => {
            // Schedule the next event
            clearTimeout(pollSetTimeoutId);
            pollSetTimeoutId = setTimeout(pollChargeModeStatus, 500);
        })
    }

    // Send scale force zero command
    function scaleForceZero() {
        const uri = `/rest/scale_action?a0=${encodeURIComponent(ScaleAction.FORCE_ZERO)}`;

        // Call the scale action URI
        fetch(uri)
        .then(response => {
            return response.json();
        })
        .then(data => {
            // console.log(data);

            var scale_action_response = data["a0"];

            if (scale_action_response == ScaleAction.FORCE_ZERO) {
                const dialogModal = document.getElementById("scaleZeroedSuccessDialog");
                dialogModal.showModal();
            }
            else {
                const dialogModal = document.getElementById("scaleZeroedFailDialog");
                dialogModal.showModal();
        }
        })
        .catch(error => {
            console.error("Error applying force zero");
        });
    }

    function servoGateSetState(state) {
        const uri = `/rest/servo_gate_state?g0=${encodeURIComponent(state)}`;

        // Call the scale action URI
        fetch(uri)
        .then(response => {
            return response.json();
        })
        .then(data => {
            // console.log(data);
        })
        .catch(error => {
            console.error("Error applying servo gate state");
        });
    }

    // Switch pages
    function onNavButtonClicked(button) {
        const sectionTrickler = document.getElementById("sectionTrickler");
        const sectionTricklerChargeMode = document.getElementById("sectionTricklerChargeMode");
        const sectionTricklerCleanUpMode = document.getElementById("sectionTricklerCleanUpMode");

        const sectionSettings = document.getElementById("sectionSettings");

        const settingsNavButton = document.getElementById("settingsNavButton")
        const purgeNavButton = document.getElementById("purgeNavButton");
        const tricklerNavButton = document.getElementById("tricklerNavButton");

        switch (button) {
            case "trickler":
                enterCleanUpMode(false);

                // Section control
                sectionSettings.style.display = "none";
                sectionTrickler.style.display = "block";
                sectionTricklerChargeMode.style.display = "block";
                sectionTricklerCleanUpMode.style.display = "none";

                // Button active control
                settingsNavButton.classList.remove("active");
                purgeNavButton.classList.remove("active");
                tricklerNavButton.classList.add("active");

                // Restart
                _restartPoll();
                break;
            case "purge":
                sectionSettings.style.display = "none";
                sectionTrickler.style.display = "block";
                sectionTricklerChargeMode.style.display = "none";
                sectionTricklerCleanUpMode.style.display = "block";

                // Button active control
                settingsNavButton.classList.remove("active");
                tricklerNavButton.classList.remove("active");
                purgeNavButton.classList.add("active");
                
                // Restart
                _restartPoll();

                // Exit Charge mode
                enterChargeMode(false);

                // Enter clean up mode
                enterCleanUpMode(true);
                break;
            case "settings":
                sectionTrickler.style.display = "none";
                sectionSettings.style.display = "block";

                // Button active control
                tricklerNavButton.classList.remove("active");
                purgeNavButton.classList.remove("active");
                settingsNavButton.classList.add("active");

                // Remove polling event
                clearTimeout(pollSetTimeoutId);

                // Load the first settings
                onSettingsLinkClicked("settings-scale");
                
                break;
            default:
                break;
        }
    }

    // Helper function to restart the poll immediately
    function _restartPoll() {
        clearTimeout(pollSetTimeoutId);
        pollSetTimeoutId = setTimeout(pollChargeModeStatus, 0);
    }

    // Functions show settings page
    function onSettingsLinkClicked(sectionId) {
        const targetSection = document.getElementById(sectionId);
        const settingsSectionTitle = document.getElementById("settingsSectionTitle");

        // Enumerate all sections to set hide/display
        const sections = document.querySelectorAll('.settings-page');

        // Set visibility
        for (const section of sections) {
            if (section.id == targetSection.id) {
                section.style.display = "block";
                settingsSectionTitle.innerText = targetSection.getAttribute("name");
            }
            else {
                section.style.display = "none";
            }
        }
        
        // Close the drawer
        const settingsDrawer = document.getElementById("settingsDrawer");
        if (settingsDrawer.checked) {
            settingsDrawer.checked = false;
        }

        // Populate values
        const form = targetSection.querySelector("form");
        if (form) {
            const uri = form.getAttribute("action");
            fetch(uri)
            .then(response => {
                return response.json();
            })
            .then(data => {
                // Populate the form
                for (const key in data) {
                    const element = form.querySelector('[name="' + key + '"]');
                    if (element) {
                        element.value = String(data[key]);
                    }
                }
            })
        }
    }

    // Function to retrieve the profile values when the index is updated
    function populateProfileSelection(select) {
        const profileIdx = select.value;
        const form = select.form;

        const uri = form.getAttribute("action") + `?pf=${encodeURIComponent(profileIdx)}`
        fetch(uri)
        .then(response => {
            return response.json();
        })
        .then(data => {
            // Populate the form
            for (const key in data) {
                const element = form.querySelector('[name="' + key + '"]');
                if (element) {
                    element.value = String(data[key]);
                }
            }
        })
    }

    // Submit the form data to the action URI
    function putForm(targetForm, saveToEeprom) {
        const paramData = new FormData(targetForm);

        // Remove empty param
        for (const [key, value] of paramData.entries()) {
            if (value == "") {
                paramData.delete(key);
            }
        }

        if (saveToEeprom) {
            paramData.append('ee', true)
        }

        const queryString = new URLSearchParams(paramData).toString();
        const uri = new URL(targetForm.action + '?');
        uri.search = queryString;

        // Post the new param with GET method
        fetch(uri)
        .then(response => {
            return response.json();
        })
        .then(data => {
            // Populate values
            const uri = targetForm.getAttribute("action");
            fetch(uri)
            .then(response => {
                return response.json();
            })
            .then(data => {
                // Populate the form
                for (const key in data) {
                    const element = targetForm.querySelector('[name="' + key + '"]');
                    if (element) {
                        element.value = String(data[key]);
                    }
                }
            })

            // Show the success modal
            const settingsAppliedSuccessDialog = document.getElementById("settingsAppliedSuccessDialog");
            settingsAppliedSuccessDialog.showModal();
        })
    }

    // Function to populate the dialog when Apply button is pressed for settings
    const allApplyButtons = document.querySelectorAll(".settings-apply-btn");
    allApplyButtons.forEach(applyButton => {
        applyButton.addEventListener("click", (event) => {
            event.preventDefault();  // Cancel default event

            const form = applyButton.form;

            // Create the dialog
            const applySettingsDialog = document.getElementById("applySettingsDialog");

            // Update dialog title
            applySettingsDialogTitle = document.getElementById("applySettingsDialogTitle");
            const sectioName = form.closest("section").getAttribute("name");
            applySettingsDialogTitle.innerText = sectioName;

            // Bind the button
            const dialogApplySettingsButton = document.getElementById("dialogApplySettingsButton");
            const dialogSaveToEepromButton = document.getElementById("dialogSaveToEepromButton");

            // Bind actions
            dialogApplySettingsButton.onclick = function() {
                putForm(form, false);
            }

            dialogSaveToEepromButton.onclick = function() {
                putForm(form, true);
            }

            // Show the dialog
            applySettingsDialog.showModal();
        })
    })

    const allApplySystemControlButton = document.querySelectorAll(".system-control-apply-btn");
    allApplySystemControlButton.forEach(applyButton => {
        applyButton.addEventListener("click", (event) => {
            event.preventDefault();  // Cancel default event

            const form = applyButton.form;

            // Create the dialog
            const applySettingsDialog = document.getElementById("applySystemControlDialog");
            const systemControlDialogWarningText = document.getElementById('systemControlDialogWarningText');

            // Update dialog content
            var formData = new FormData(form);
            let bodyText = '<ul class="list-disc">';
            if (formData.get("s4") == 'true') {
                bodyText += "<li>Save all settings to EEPROM</li>";
            }
            if (formData.get("s5") == 'true') {
                bodyText += "<li>Reboot the OpenTrickler</li>";
            }
            if (formData.get("s6") == 'true') {
                bodyText += "<li>Erase the EEPROM. You cannot undo this action!</li>";
            }
            bodyText += "</ul>";

            systemControlDialogWarningText.innerHTML = bodyText;


            // Bind the button
            const dialogApplySettingsButton = document.getElementById("dialogSystemControlApplySettingsButton");

            // Bind actions
            dialogApplySettingsButton.onclick = function() {
                putForm(form, false);
            }

            // Show the dialog
            applySettingsDialog.showModal();
        })
    })

    function debounce(callback, delay) {
        let timer
        return function() {
            clearTimeout(timer)
            timer = setTimeout(() => {
                callback();
            }, delay)
        }
    }

    // Update the trickler move speed in cleanup mode based on the slider input
    function onTricklerSpeedUpdate() {
        const new_speed = document.getElementById("tricklerSpeedSlider").value;
        const uri = `/rest/cleanup_mode_state?s1=${encodeURIComponent(new_speed)}`;
        fetch(uri);
    }
    const debouncedOnTricklerSpeedUpdate = debounce(onTricklerSpeedUpdate, 20);

    function onStopCleanupButtonClicked() {
        document.getElementById("tricklerSpeedSlider").value = "0";
        const uri = `/rest/cleanup_mode_state?s1=${encodeURIComponent(0)}`;
        fetch(uri);
    }

    // Enter or exit the clean up mode
    function enterCleanUpMode(enter) {
        var cleanup_state_value = null;
        if (enter) {
            cleanup_state_value = CleanupModeState.ENTER;
        }
        else {
            cleanup_state_value = CleanupModeState.EXIT;
        }
        const uri = `/rest/cleanup_mode_state?s0=${encodeURIComponent(cleanup_state_value)}`;
        fetch(uri);
    }

    async function onExportProfileBtnClicked(event) {
        // Skip the default response
        event.preventDefault();

        const config = {};

        // Read metadata
        let response = await fetch("/rest/system_control");
        const system_control_data = await response.json();
        config["unique_id"] = system_control_data["s0"];
        config["firmware_version"] = system_control_data["s1"];
        config["vcs_hash"] = system_control_data["s2"];
        config["config"] = {};

        // get current selected profile
        const select_profile = document.getElementById("select_profile_option");

        // Fetch data from endpoints
        const url_string = `/rest/profile_config?pf=${select_profile.value}`
        response = await fetch(url_string);
        const profile_data = await response.json();
        config["config"][url_string] = profile_data;

        // download as a file
        const blob = new Blob([JSON.stringify(config, null, "\t")], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = profile_data["p2"] + ".json"
        a.click();
        URL.revokeObjectURL(url);
    }

    async function onExportConfigClicked() {
        const config = {};

        const endpoints = [
            "/rest/scale_config",
            "/rest/charge_mode_config",
            "/rest/coarse_motor_config",
            "/rest/fine_motor_config",
            "/rest/mini_12864_config",
            "/rest/wireless_config",
            "/rest/neopixel_led_config",
            "/rest/profile_config?pf=0",
            "/rest/profile_config?pf=1",
            "/rest/profile_config?pf=2",
            "/rest/profile_config?pf=3",
            "/rest/profile_config?pf=4",
            "/rest/profile_config?pf=5",
            "/rest/profile_config?pf=6",
            "/rest/profile_config?pf=7",
            "/rest/servo_gate_config",
        ]

        // Read metadata
        const response = await fetch("/rest/system_control");
        const system_control_data = await response.json();
        config["unique_id"] = system_control_data["s0"];
        config["firmware_version"] = system_control_data["s1"];
        config["vcs_hash"] = system_control_data["s2"];
        config["config"] = {};

        // Fetch data from endpoints
        for (const endpoint of endpoints) {
            const response = await fetch(endpoint);
            const data = await response.json();
            config["config"][endpoint] = data;
        }

        // download as a file
        const blob = new Blob([JSON.stringify(config, null, "\t")], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "opentrickler_"+config["unique_id"]+"_config.json";
        a.click();
        URL.revokeObjectURL(url);
    }

    async function onImportConfigClicked() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file')
        input.setAttribute('multiple', 'false')
        input.setAttribute('accept', '.json')

        input.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            // Setup the callbacks
            const reader = new FileReader();
            reader.onload = (event2) => {
                try {
                    const data = JSON.parse(reader.result);
    
                    // Process data
                    const source_firmware_version = data["firmware_version"];
                    const source_unique_id = data["unique_id"];
                    const source_vcs_hash = data["vcs_hash"];
                    const config = data["config"];

                    // Restore settings
                    for (const [endpoint, config_data] of Object.entries(config)) {
                        const paramData = new FormData();
                        for (const [key, value] of Object.entries(config_data)) {
                            paramData.append(key, value);
                        }

                        // Create URI
                        const queryString = new URLSearchParams(paramData).toString();
                        const uri = new URL(endpoint + "?", window.location.origin);
                        uri.search = queryString;
                        fetch(uri);
                    }

                    // Update form
                    const systemControlForm = document.getElementById("systemControlForm");
                    systemControlForm.elements["s4"].value = true;  // Save to EEPROM
                    systemControlForm.elements["s5"].value = true;  // Reboot
                    
                    // Prompt user to save and reboot
                    const applyBtn = document.getElementById("system_control_apply_btn");
                    applyBtn.click();
                } 
                catch (exception) {
                    console.error(exception);

                    // Show warning 
                    const settingsRestoreFailedDialog = document.getElementById("settingsRestoreFailedDialog");
                    const settingsRestoreFailedText = document.getElementById("settingsRestoreFailedText");

                    settingsRestoreFailedText.innerHTML = `<h3 class="font-bold text-lg">Failed to Restore Settings</h3><p class="py-4">${exception}</p>`
                    settingsRestoreFailedDialog.showModal();
                }
            }

            reader.readAsText(file);
        }
        input.click();
    }

    // Start the long polling process when the page loads
    if (document.readyState != "loading") {
        onNavButtonClicked('trickler');
    }
    else {
        document.addEventListener('DOMContentLoaded', function() {onNavButtonClicked('trickler');});
    }

</script>

</body>

</html>